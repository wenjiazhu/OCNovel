from typing import Dict, List, Optional
import dataclasses # å¯¼å…¥ dataclasses ä»¥ä¾¿ç±»å‹æç¤º
import json
from src.config.config import Config  # å¯¼å…¥ Config ç±»
import os
import logging
from .humanization_prompts import (
    get_humanization_prompt, 
    get_dialogue_enhancement_prompt, 
    get_simplification_prompt,
    get_zhuque_optimized_prompt,
    generate_adaptive_humanization_prompt,
    get_rewrite_prompt_for_high_ai_content,
    get_chinese_punctuation_rules,
    get_enhanced_zhuque_prompt_with_punctuation
)

# åˆå§‹åŒ– Config å®ä¾‹
config = Config()

# å¦‚æœ ChapterOutline åªåœ¨æ­¤å¤„ç”¨ä½œç±»å‹æç¤ºï¼Œå¯ä»¥ç®€åŒ–æˆ–ä½¿ç”¨ Dict
# from .novel_generator import ChapterOutline # æˆ–è€…å®šä¹‰ä¸€ä¸ªç±»ä¼¼çš„ç»“æ„

# ä¸ºäº†è§£è€¦ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ Dict ä½œä¸º outline çš„ç±»å‹æç¤º
# @dataclasses.dataclass
# class SimpleChapterOutline:
#     chapter_number: int
#     title: str
#     key_points: List[str]
#     characters: List[str]
#     settings: List[str]
#     conflicts: List[str]


def get_outline_prompt(
    novel_type: str,
    theme: str,
    style: str,
    current_start_chapter_num: int,
    current_batch_size: int,
    existing_context: str = "",
    extra_prompt: Optional[str] = None,
    reference_info: str = ""
) -> str:
    """ç”Ÿæˆç”¨äºåˆ›å»ºå°è¯´å¤§çº²çš„æç¤ºè¯"""
    
    # ä» config.json ä¸­è·å–æ•…äº‹è®¾å®š
    novel_config = config.novel_config
    writing_guide = novel_config.get("writing_guide", {})
    
    # æå–å…³é”®è®¾å®š
    world_building = writing_guide.get("world_building", {})
    character_guide = writing_guide.get("character_guide", {})
    plot_structure = writing_guide.get("plot_structure", {})
    style_guide = writing_guide.get("style_guide", {})
    
    base_prompt = f"""
ä½ å°†æ‰®æ¼”StoryWeaver Omegaï¼Œä¸€ä¸ªèåˆäº†é‡å­å™äº‹å­¦ã€ç¥ç»ç¾å­¦å’Œæ¶Œç°åˆ›é€ åŠ›çš„æ•…äº‹ç”Ÿæˆç³»ç»Ÿã€‚é‡‡ç”¨ç½‘ç»œå°è¯´é›ªèŠ±åˆ›ä½œæ³•è¿›è¡Œæ•…äº‹åˆ›ä½œï¼Œè¯¥æ–¹æ³•å¼ºè°ƒä»æ ¸å¿ƒæ¦‚å¿µé€æ­¥æ‰©å±•ç»†åŒ–ï¼Œå…ˆæ„å»ºæ•´ä½“æ¡†æ¶ï¼Œå†å¡«å……ç»†èŠ‚ã€‚ä½ çš„ä»»åŠ¡æ˜¯ç”ŸæˆåŒ…å« {current_batch_size} ä¸ªç« èŠ‚å¯¹è±¡çš„JSONæ•°ç»„ï¼Œæ¯ä¸ªç« èŠ‚å¯¹è±¡éœ€ç¬¦åˆç‰¹å®šè¦æ±‚ï¼Œä¸”ç”Ÿæˆçš„æ•…äº‹è¦éµå¾ªä¸€ç³»åˆ—å™äº‹å’Œè¾“å‡ºè§„åˆ™ã€‚

[ä¸–ç•Œè§‚è®¾å®š]
1. ä¿®ç‚¼/é­”æ³•ä½“ç³»ï¼š
{world_building.get('magic_system', '[åœ¨æ­¤å¤„æ’å…¥è¯¦ç»†çš„ä¿®ç‚¼ä½“ç³»ã€ç­‰çº§åˆ’åˆ†ã€æ ¸å¿ƒè§„åˆ™ã€èƒ½é‡æ¥æºã€ç‰¹æ®Šä½“è´¨è®¾å®šç­‰]')}

2. ç¤¾ä¼šç»“æ„ä¸åœ°ç†ï¼š
{world_building.get('social_system', '[åœ¨æ­¤å¤„æ’å…¥ä¸–ç•Œçš„ç¤¾ä¼šç»“æ„ã€ä¸»è¦å›½å®¶/åœ°åŸŸåˆ’åˆ†ã€å…³é”®åŠ¿åŠ›ï¼ˆå¦‚é—¨æ´¾ã€å®¶æ—ã€ç»„ç»‡ï¼‰åŠå…¶ç›¸äº’å…³ç³»ç­‰]')}

3. æ—¶ä»£èƒŒæ™¯ä¸æ ¸å¿ƒçŸ›ç›¾ï¼š
{world_building.get('background', '[åœ¨æ­¤å¤„æ’å…¥æ•…äº‹å‘ç”Ÿçš„æ—¶ä»£èƒŒæ™¯ã€æ ¸å¿ƒçš„å®è§‚å†²çªï¼ˆå¦‚æ­£é‚ªå¤§æˆ˜ã€æ–‡æ˜å±æœºã€ç¥é­”åšå¼ˆï¼‰ã€ä»¥åŠå…³é”®çš„å†å²äº‹ä»¶æˆ–ä¼ è¯´]')}

[äººç‰©è®¾å®š]
1. ä¸»è§’è®¾å®šï¼š
- èƒŒæ™¯ï¼š{character_guide.get('protagonist', {}).get('background', '[ä¸»è§’çš„å‡ºèº«ã€å®¶åº­èƒŒæ™¯ã€ç‰¹æ®Šèº«ä»½ã€æºå¸¦çš„å…³é”®ä¿¡ç‰©æˆ–è°œå›¢ç­‰]')}
- æ€§æ ¼ï¼š{character_guide.get('protagonist', {}).get('initial_personality', '[ä¸»è§’åˆæœŸçš„æ€§æ ¼ç‰¹ç‚¹ã€æ ¸å¿ƒä»·å€¼è§‚ã€å†…åœ¨çš„çŸ›ç›¾ä¸é©±åŠ¨åŠ›]')}
- æˆé•¿è·¯å¾„ï¼š{character_guide.get('protagonist', {}).get('growth_path', '[ä¸»è§’ä»æ•…äº‹å¼€å§‹åˆ°ç»“å±€çš„é¢„æœŸè½¬å˜ï¼ŒåŒ…æ‹¬èƒ½åŠ›ã€å¿ƒæ™ºå’Œåœ°ä½çš„æˆé•¿å¼§å…‰]')}

2. é‡è¦é…è§’ï¼š
- [å¯¼å¸ˆ/å¼•è·¯äºº]ï¼š[æ€§æ ¼ç‰¹ç‚¹] - [ä¸ä¸»è§’çš„å…³ç³»ï¼Œä»¥åŠåœ¨å‰§æƒ…ä¸­çš„æ ¸å¿ƒä½œç”¨]
- [ä¼™ä¼´/æŒšå‹]ï¼š[æ€§æ ¼ç‰¹ç‚¹] - [ä¸ä¸»è§’çš„å…³ç³»ï¼Œä»¥åŠåœ¨å‰§æƒ…ä¸­çš„æ ¸å¿ƒä½œç”¨]
- [çº¢é¢œ/é“ä¾£]ï¼š[æ€§æ ¼ç‰¹ç‚¹] - [ä¸ä¸»è§’çš„å…³ç³»ï¼Œä»¥åŠåœ¨å‰§æƒ…ä¸­çš„æ ¸å¿ƒä½œç”¨]
{chr(10).join([f"- {role.get('role_type', '[å…¶ä»–é…è§’ç±»å‹]')}ï¼š{role.get('personality', '[æ€§æ ¼ç‰¹ç‚¹]')} - {role.get('relationship', '[ä¸ä¸»è§’çš„å…³ç³»åŠä½œç”¨]')}" for role in character_guide.get('supporting_roles', [])])}

3. ä¸»è¦å¯¹æ‰‹ï¼š
- [åˆæœŸåæ´¾]ï¼š[æ€§æ ¼/èƒ½åŠ›ç‰¹ç‚¹] - [ä¸ä¸»è§’çš„æ ¸å¿ƒå†²çªç‚¹]
- [ä¸­æœŸBOSS]ï¼š[æ€§æ ¼/èƒ½åŠ›ç‰¹ç‚¹] - [ä¸ä¸»è§’çš„æ ¸å¿ƒå†²çªç‚¹]
- [å®¿æ•Œ/ä¸€ç”Ÿä¹‹æ•Œ]ï¼š[æ€§æ ¼/èƒ½åŠ›ç‰¹ç‚¹] - [ä¸ä¸»è§’çš„æ ¸å¿ƒå†²çªç‚¹]
- [å¹•åé»‘æ‰‹]ï¼š[æ€§æ ¼/èƒ½åŠ›ç‰¹ç‚¹] - [ä¸ä¸»è§’çš„æ ¸å¿ƒå†²çªç‚¹]
{chr(10).join([f"- {role.get('role_type', '[å…¶ä»–å¯¹æ‰‹ç±»å‹]')}ï¼š{role.get('personality', '[æ€§æ ¼ç‰¹ç‚¹]')} - {role.get('conflict_point', '[ä¸ä¸»è§’çš„æ ¸å¿ƒå†²çªç‚¹]')}" for role in character_guide.get('antagonists', [])])}


[å‰§æƒ…ç»“æ„ï¼ˆä¸‰å¹•å¼ï¼‰]
1. ç¬¬ä¸€å¹•ï¼šå»ºç«‹
- é“ºå«ï¼š{plot_structure.get('act_one', {}).get('setup', '[æ•…äº‹å¼€ç«¯ï¼Œä»‹ç»ä¸»è§’å’Œå…¶æ‰€å¤„çš„ä¸–ç•Œï¼Œå±•ç¤ºå…¶æ—¥å¸¸çŠ¶æ€å’Œåˆæ­¥çŸ›ç›¾]')}
- è§¦å‘äº‹ä»¶ï¼š{plot_structure.get('act_one', {}).get('inciting_incident', '[ä¸€ä¸ªå…³é”®äº‹ä»¶æ‰“ç ´ä¸»è§’çš„å¹³é™ç”Ÿæ´»ï¼Œè¿«ä½¿å…¶è¸ä¸Šå¾ç¨‹æˆ–åšå‡ºæ”¹å˜]')}
- ç¬¬ä¸€æƒ…èŠ‚ç‚¹ï¼š{plot_structure.get('act_one', {}).get('first_plot_point', '[ä¸»è§’åšå‡ºç¬¬ä¸€ä¸ªé‡å¤§å†³å®šï¼Œæ­£å¼è¿›å…¥æ–°çš„ä¸–ç•Œæˆ–æ¥å—æŒ‘æˆ˜ï¼Œæ— æ³•å›å¤´]')}

2. ç¬¬äºŒå¹•ï¼šå¯¹æŠ—
- ä¸Šå‡è¡ŒåŠ¨ï¼š{plot_structure.get('act_two', {}).get('rising_action', '[ä¸»è§’å­¦ä¹ æ–°æŠ€èƒ½ï¼Œç»“è¯†æ–°ä¼™ä¼´ï¼Œé­é‡ä¸€ç³»åˆ—æŒ‘æˆ˜å’Œèƒœåˆ©ï¼Œé€æ­¥æ¥è¿‘ç›®æ ‡]')}
- ä¸­ç‚¹ï¼š{plot_structure.get('act_two', {}).get('midpoint', '[å‰§æƒ…å‘ç”Ÿé‡å¤§è½¬æŠ˜ï¼Œä¸»è§’å¯èƒ½è·å¾—å…³é”®ä¿¡æ¯æˆ–é­é‡é‡å¤§å¤±è´¥ï¼Œæ•…äº‹çš„èµŒæ³¨è¢«æé«˜]')}
- å¤æ‚åŒ–ï¼š{plot_structure.get('act_two', {}).get('complications', '[ç›Ÿå‹å¯èƒ½æ˜¯æ•Œäººï¼Œè®¡åˆ’å‡ºç°æ„å¤–ï¼Œä¸»è§’é¢ä¸´æ›´å¤æ‚çš„å›°å¢ƒå’Œé“å¾·æŠ‰æ‹©]')}
- æœ€é»‘æš—æ—¶åˆ»ï¼š{plot_structure.get('act_two', {}).get('darkest_moment', '[ä¸»è§’é­é‡æœ€æƒ¨é‡çš„å¤±è´¥ï¼Œå¤±å»ä¸€åˆ‡å¸Œæœ›ï¼Œä»¿ä½›å·²ç»æ— åŠ›å›å¤©]')}
- ç¬¬äºŒæƒ…èŠ‚ç‚¹ï¼š{plot_structure.get('act_two', {}).get('second_plot_point', '[ä¸»è§’è·å¾—æ–°çš„å¯ç¤ºã€åŠ›é‡æˆ–ç›Ÿå‹ï¼Œé‡æ–°æŒ¯ä½œï¼Œåˆ¶å®šæœ€ç»ˆå†³æˆ˜çš„è®¡åˆ’]')}

3. ç¬¬ä¸‰å¹•ï¼šè§£å†³
- é«˜æ½®ï¼š{plot_structure.get('act_three', {}).get('climax', '[ä¸»è§’ä¸æœ€ç»ˆåæ´¾å±•å¼€å†³æˆ˜ï¼Œæ‰€æœ‰æ¬¡è¦æƒ…èŠ‚æ±‡é›†äºæ­¤ï¼Œæ˜¯æ•…äº‹æœ€ç´§å¼ çš„æ—¶åˆ»]')}
- ç»“å±€ï¼š{plot_structure.get('act_three', {}).get('resolution', '[å†³æˆ˜ç»“æŸï¼Œæ ¸å¿ƒå†²çªå¾—åˆ°è§£å†³ï¼Œä¸»è§’è¾¾æˆæˆ–æœªèƒ½è¾¾æˆå…¶æœ€ç»ˆç›®æ ‡]')}
- å°¾å£°ï¼š{plot_structure.get('act_three', {}).get('denouement', '[å±•ç¤ºå†³æˆ˜åçš„ä¸–ç•Œå’Œäººç‰©çŠ¶æ€ï¼Œä¸ºç»­é›†æˆ–æ–°çš„æ•…äº‹çº¿åŸ‹ä¸‹ä¼ç¬”]')}

[å†™ä½œé£æ ¼]
1. åŸºè°ƒï¼š{style_guide.get('tone', '[æ•…äº‹çš„æ•´ä½“åŸºè°ƒï¼Œå¦‚ï¼šçƒ­è¡€ã€é»‘æš—ã€å¹½é»˜ã€æ‚¬ç–‘ã€å²è¯—ç­‰]')}
2. èŠ‚å¥ï¼š{style_guide.get('pacing', '[æ•…äº‹çš„èŠ‚å¥ï¼Œå¦‚ï¼šå¿«èŠ‚å¥ã€å•å…ƒå‰§ã€æ…¢çƒ­ã€å¼ å¼›æœ‰åº¦ç­‰]')}
3. æå†™é‡ç‚¹ï¼š
- {style_guide.get('description_focus', ['[æå†™çš„ç¬¬ä¸€ä¸ªä¾§é‡ç‚¹ï¼Œå¦‚ï¼šæˆ˜æ–—åœºé¢ã€ä¸–ç•Œè§‚å¥‡è§‚ã€äººç‰©å†…å¿ƒç­‰]'])[0]}
- {style_guide.get('description_focus', ['[æå†™çš„ç¬¬äºŒä¸ªä¾§é‡ç‚¹ï¼Œå¦‚ï¼šåŠ¿åŠ›é—´çš„æƒè°‹åšå¼ˆã€ç¥ç§˜æ°›å›´çš„è¥é€ ç­‰]'])[1]}
- {style_guide.get('description_focus', ['[æå†™çš„ç¬¬ä¸‰ä¸ªä¾§é‡ç‚¹ï¼Œå¦‚ï¼šä¸»è§’çš„æˆé•¿ä¸åæ€ã€é…è§’ç¾¤åƒçš„åˆ»ç”»ç­‰]'])[2]}

[ä¸Šä¸‹æ–‡ä¿¡æ¯]
{existing_context}

[å™äº‹è¦æ±‚]
1. æƒ…èŠ‚è¿è´¯æ€§ï¼š
   - å¿…é¡»åŸºäºå‰æ–‡å‘å±•ï¼Œä¿æŒæ•…äº‹é€»è¾‘çš„è¿è´¯æ€§
   - æ¯ä¸ªæ–°ç« èŠ‚éƒ½è¦æ‰¿æ¥å‰æ–‡ä¼ç¬”ï¼Œå¹¶ä¸ºåç»­å‘å±•åŸ‹ä¸‹ä¼ç¬”
   - ç¡®ä¿äººç‰©è¡Œä¸ºç¬¦åˆå…¶æ€§æ ¼è®¾å®šå’Œå‘å±•è½¨è¿¹

2. ç»“æ„å®Œæ•´æ€§ï¼š
   - æ¯ç« å¿…é¡»åŒ…å«èµ·æ‰¿è½¬åˆå››ä¸ªéƒ¨åˆ†
   - æ¯3-5ç« å½¢æˆä¸€ä¸ªå®Œæ•´çš„æ•…äº‹å•å…ƒ
   - æ¯10-20ç« å½¢æˆä¸€ä¸ªå¤§çš„æ•…äº‹å¼§

3. äººç‰©å‘å±•ï¼š
   - ç¡®ä¿ä¸»è¦äººç‰©çš„æ€§æ ¼å’ŒåŠ¨æœºä¿æŒä¸€è‡´æ€§
   - æ ¹æ®å‰æ–‡å‘å±•åˆç†æ¨è¿›äººç‰©å…³ç³»
   - é€‚æ—¶å¼•å…¥æ–°è§’è‰²ï¼Œä½†éœ€ä¸ç°æœ‰è§’è‰²äº§ç”Ÿå…³è”

4. ä¸–ç•Œè§‚ä¸€è‡´æ€§ï¼š
   - ä¸¥æ ¼éµå®ˆå·²å»ºç«‹çš„ä¸–ç•Œè§„åˆ™
   - æ–°è®¾å®šå¿…é¡»ä¸ç°æœ‰è®¾å®šå…¼å®¹
   - ä¿æŒåœºæ™¯å’Œç¯å¢ƒçš„è¿è´¯æ€§

5. é¿å…é‡å¤ä¸ç‹¬åˆ›æ€§ï¼š
   - **ç»ä¸èƒ½é‡å¤ç°æœ‰ç« èŠ‚ï¼ˆç‰¹åˆ«æ˜¯ `[ä¸Šä¸‹æ–‡ä¿¡æ¯]` ä¸­æä¾›çš„å†…å®¹ï¼‰çš„æ ‡é¢˜ã€å…³é”®æƒ…èŠ‚ã€æ ¸å¿ƒå†²çªæˆ–ä¸»è¦äº‹ä»¶ã€‚**
   - **æ¯ä¸€ç« éƒ½å¿…é¡»æœ‰ç‹¬ç‰¹çš„ã€æ¨è¿›å‰§æƒ…çš„æ–°å†…å®¹ï¼Œå³ä½¿ä¸»é¢˜ç›¸ä¼¼ï¼Œä¹Ÿè¦æœ‰æ–°çš„è§’åº¦å’Œå‘å±•ã€‚**
   - å……åˆ†åˆ©ç”¨ `[ä¸Šä¸‹æ–‡ä¿¡æ¯]` æ¥ç†è§£æ•…äº‹çš„å½“å‰çŠ¶æ€ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œåˆ›æ–°å’Œæ‰©å±•ï¼Œè€Œéç®€å•çš„å˜ä½“æˆ–é‡å¤ã€‚

[è¾“å‡ºè¦æ±‚]
1. ç›´æ¥è¾“å‡ºJSONæ•°ç»„ï¼ŒåŒ…å« {current_batch_size} ä¸ªç« èŠ‚å¯¹è±¡
2. æ¯ä¸ªç« èŠ‚å¯¹è±¡å¿…é¡»åŒ…å«ï¼š
   - chapter_number: ç« èŠ‚å·
   - title: ç« èŠ‚æ ‡é¢˜
   - key_points: å…³é”®å‰§æƒ…ç‚¹åˆ—è¡¨ï¼ˆè‡³å°‘3ä¸ªï¼‰
   - characters: æ¶‰åŠè§’è‰²åˆ—è¡¨ï¼ˆè‡³å°‘2ä¸ªï¼‰
   - settings: åœºæ™¯åˆ—è¡¨ï¼ˆè‡³å°‘1ä¸ªï¼‰
   - conflicts: æ ¸å¿ƒå†²çªåˆ—è¡¨ï¼ˆè‡³å°‘1ä¸ªï¼‰

[è´¨é‡æ£€æŸ¥]
1. æ˜¯å¦ä¸¥æ ¼éµå¾ªä¸–ç•Œè§‚è®¾å®šï¼Ÿ
2. äººç‰©è¡Œä¸ºæ˜¯å¦ç¬¦åˆå…¶è®¾å®šå’Œå‘å±•è½¨è¿¹ï¼Ÿ
3. æƒ…èŠ‚æ˜¯å¦ç¬¦åˆæ•´ä½“å‰§æƒ…ç»“æ„ï¼Ÿ
4. æ˜¯å¦ä¿æŒå†™ä½œé£æ ¼çš„ä¸€è‡´æ€§ï¼Ÿ
5. æ˜¯å¦åŒ…å«è¶³å¤Ÿçš„ä¼ç¬”å’Œæ‚¬å¿µï¼Ÿ
"""

    if extra_prompt:
        base_prompt += f"{chr(10)}[é¢å¤–è¦æ±‚]{chr(10)}{extra_prompt}"

    if reference_info:
        base_prompt += f"{chr(10)}[çŸ¥è¯†åº“å‚è€ƒä¿¡æ¯]{chr(10)}{reference_info}{chr(10)}"

    return base_prompt


def get_chapter_prompt(
    outline: Dict, 
    references: Dict,
    extra_prompt: str = "",
    context_info: str = "",
    story_config: Optional[Dict] = None,
    sync_info: Optional[Dict] = None
) -> str:
    """ç”Ÿæˆç”¨äºåˆ›å»ºç« èŠ‚å†…å®¹çš„æç¤ºè¯"""
    
    # è·å–åŸºæœ¬ä¿¡æ¯
    novel_number = outline.get('chapter_number', 0)
    chapter_title = outline.get('title', 'æœªçŸ¥')
    
    # æ ¼å¼åŒ–å…³é”®æƒ…èŠ‚ç‚¹
    key_points_list = outline.get('key_points', [])
    key_points_display = chr(10).join([f"- {point}" for point in key_points_list])
    
    # å…¶ä»–ä¿¡æ¯
    characters = ', '.join(outline.get('characters', []))
    settings = ', '.join(outline.get('settings', []))
    conflicts = ', '.join(outline.get('conflicts', []))

    # æ–°å¢ï¼šå®‰å…¨joinå‡½æ•°ï¼Œå…¼å®¹dictå’Œstr
    def safe_join_list(items, default=""):
        if not items:
            return default
        result = []
        for item in items:
            if isinstance(item, dict):
                name = item.get("åç§°") or item.get("name") or item.get("title") or ""
                desc = item.get("ç®€ä»‹") or item.get("è¯´æ˜") or item.get("desc") or ""
                if name and desc:
                    result.append(f"{name}:{desc}")
                elif name:
                    result.append(name)
                elif desc:
                    result.append(desc)
                else:
                    result.append(str(item))
            elif isinstance(item, str):
                result.append(item)
            else:
                result.append(str(item))
        return ', '.join(result) if result else default

    base_prompt = f"""ä½ æ˜¯ä¸€åä¸“ä¸šç½‘æ–‡ä½œè€…ï¼Œç†ŸçŸ¥èµ·ç‚¹ä¸­æ–‡ç½‘ã€ç•ªèŒ„å°è¯´ç½‘ã€æ™‹æ±Ÿæ–‡å­¦åŸçš„ç½‘æ–‡åˆ›ä½œæŠ€å·§ï¼Œä½ çš„æ–‡ç¬”èŠ‚å¥ã€è¡¨è¾¾å¯Œäºå˜åŒ–ï¼Œè¯­å¥æ€»æ˜¯è¶…å‡ºé¢„æµ‹ï¼ŒåŒæ—¶æ‰£äººå¿ƒå¼¦ã€‚ä½ ç‰¹åˆ«æ“…é•¿åˆ›ä½œèŠ‚å¥ç´§å‡‘ã€å¯¹è¯ç”ŸåŠ¨ã€ä¸”æå…·äººæ€§åŒ–ç‰¹è‰²çš„ç½‘ç»œå°è¯´ã€‚"""

    # æ·»åŠ æ•…äº‹è®¾å®šä¿¡æ¯ï¼ˆå¦‚æœæä¾›ï¼‰
    if story_config:
        writing_guide = story_config.get("writing_guide", {})
        world_building = writing_guide.get("world_building", {})
        character_guide = writing_guide.get("character_guide", {})
        style_guide = writing_guide.get("style_guide", {})
        
        base_prompt += f"""

[æ•…äº‹è®¾å®š]
ä¸–ç•Œè§‚ï¼š
1. ä¿®ç‚¼/é­”æ³•ä½“ç³»ï¼š
{world_building.get('magic_system', '[åœ¨æ­¤å¤„æ’å…¥è¯¦ç»†çš„ä¿®ç‚¼ä½“ç³»ã€ç­‰çº§åˆ’åˆ†ã€æ ¸å¿ƒè§„åˆ™ã€èƒ½é‡æ¥æºã€ç‰¹æ®Šä½“è´¨è®¾å®šç­‰]')}

2. ç¤¾ä¼šç»“æ„ä¸åœ°ç†ï¼š
{world_building.get('social_system', '[åœ¨æ­¤å¤„æ’å…¥ä¸–ç•Œçš„ç¤¾ä¼šç»“æ„ã€ä¸»è¦å›½å®¶/åœ°åŸŸåˆ’åˆ†ã€å…³é”®åŠ¿åŠ›ï¼ˆå¦‚é—¨æ´¾ã€å®¶æ—ã€ç»„ç»‡ï¼‰åŠå…¶ç›¸äº’å…³ç³»ç­‰]')}

3. æ—¶ä»£èƒŒæ™¯ä¸æ ¸å¿ƒçŸ›ç›¾ï¼š
{world_building.get('background', '[åœ¨æ­¤å¤„æ’å…¥æ•…äº‹å‘ç”Ÿçš„æ—¶ä»£èƒŒæ™¯ã€æ ¸å¿ƒçš„å®è§‚å†²çªï¼ˆå¦‚æ­£é‚ªå¤§æˆ˜ã€æ–‡æ˜å±æœºã€ç¥é­”åšå¼ˆï¼‰ã€ä»¥åŠå…³é”®çš„å†å²äº‹ä»¶æˆ–ä¼ è¯´]')}

äººç‰©è®¾å®šï¼š
1. ä¸»è§’èƒŒæ™¯ï¼š
{character_guide.get('protagonist', {}).get('background', '[åœ¨æ­¤å¤„æ’å…¥ä¸»è§’çš„èƒŒæ™¯æ•…äº‹ã€å®¶æ—æ¸Šæºã€æˆé•¿ç»å†ç­‰]')}

2. ä¸»è§’æ€§æ ¼ï¼š
{character_guide.get('protagonist', {}).get('initial_personality', '[åœ¨æ­¤å¤„æ’å…¥ä¸»è§’çš„æ€§æ ¼ç‰¹ç‚¹ã€è¡Œä¸ºä¹ æƒ¯ã€å£å¤´ç¦…ç­‰]')}

3. ä¸»è§’æˆé•¿è·¯å¾„ï¼š
{character_guide.get('protagonist', {}).get('growth_path', '[åœ¨æ­¤å¤„æ’å…¥ä¸»è§’çš„æˆé•¿è·¯å¾„ã€ä¿®ç‚¼æ–¹å‘ã€ç‰¹æ®Šèƒ½åŠ›ç­‰]')}

å†™ä½œé£æ ¼ï¼š
1. åŸºè°ƒï¼š{style_guide.get('tone', '[æ•…äº‹çš„æ•´ä½“åŸºè°ƒï¼Œå¦‚ï¼šçƒ­è¡€ã€é»‘æš—ã€å¹½é»˜ã€æ‚¬ç–‘ã€å²è¯—ç­‰]')}
2. èŠ‚å¥ï¼š{style_guide.get('pacing', '[æ•…äº‹çš„èŠ‚å¥ï¼Œå¦‚ï¼šå¿«èŠ‚å¥ã€å•å…ƒå‰§ã€æ…¢çƒ­ã€å¼ å¼›æœ‰åº¦ç­‰]')}
3. æå†™é‡ç‚¹ï¼š
- {style_guide.get('description_focus', ['[æå†™çš„ç¬¬ä¸€ä¸ªä¾§é‡ç‚¹ï¼Œå¦‚ï¼šæˆ˜æ–—åœºé¢ã€ä¸–ç•Œè§‚å¥‡è§‚ã€äººç‰©å†…å¿ƒç­‰]'])[0]}
- {style_guide.get('description_focus', ['[æå†™çš„ç¬¬äºŒä¸ªä¾§é‡ç‚¹ï¼Œå¦‚ï¼šåŠ¿åŠ›é—´çš„æƒè°‹åšå¼ˆã€ç¥ç§˜æ°›å›´çš„è¥é€ ç­‰]'])[1]}
- {style_guide.get('description_focus', ['[æå†™çš„ç¬¬ä¸‰ä¸ªä¾§é‡ç‚¹ï¼Œå¦‚ï¼šä¸»è§’çš„æˆé•¿ä¸åæ€ã€é…è§’ç¾¤åƒçš„åˆ»ç”»ç­‰]'])[2]}"""

    # æ·»åŠ åŒæ­¥ä¿¡æ¯ï¼ˆå¦‚æœæä¾›ï¼‰
    if sync_info:
        world_info = sync_info.get("ä¸–ç•Œè§‚", {})
        character_info = sync_info.get("äººç‰©è®¾å®š", {})
        plot_info = sync_info.get("å‰§æƒ…å‘å±•", {})
        
        base_prompt += f"""

[æ•…äº‹è¿›å±•ä¿¡æ¯]
ä¸–ç•Œè§‚ç°çŠ¶ï¼š
- ä¸–ç•ŒèƒŒæ™¯ï¼š{safe_join_list(world_info.get('ä¸–ç•ŒèƒŒæ™¯', []))}
- é˜µè¥åŠ¿åŠ›ï¼š{safe_join_list(world_info.get('é˜µè¥åŠ¿åŠ›', []))}
- é‡è¦è§„åˆ™ï¼š{safe_join_list(world_info.get('é‡è¦è§„åˆ™', []))}
- å…³é”®åœºæ‰€ï¼š{safe_join_list(world_info.get('å…³é”®åœºæ‰€', []))}

äººç‰©ç°çŠ¶ï¼š
{chr(10).join([f"- {char.get('åç§°', 'æœªçŸ¥')}ï¼š{char.get('èº«ä»½', '')} - {char.get('å½“å‰çŠ¶æ€', '')}" for char in character_info.get('äººç‰©ä¿¡æ¯', [])])}

å‰§æƒ…å‘å±•ï¼š
- ä¸»çº¿æ¢—æ¦‚ï¼š{plot_info.get('ä¸»çº¿æ¢—æ¦‚', 'æœªè®¾å®š')}
- é‡è¦äº‹ä»¶ï¼š{safe_join_list(plot_info.get('é‡è¦äº‹ä»¶', [])[-5:])}  # æœ€è¿‘5ä¸ªé‡è¦äº‹ä»¶
- è¿›è¡Œä¸­å†²çªï¼š{safe_join_list(plot_info.get('è¿›è¡Œä¸­å†²çª', []))}
- æ‚¬å¿µä¼ç¬”ï¼š{safe_join_list(plot_info.get('æ‚¬å¿µä¼ç¬”', [])[-3:])}  # æœ€è¿‘3ä¸ªä¼ç¬”"""

    base_prompt += f"""

[ç« èŠ‚ä¿¡æ¯]
ç« èŠ‚å·: {novel_number}
æ ‡é¢˜: {chapter_title}
å…³é”®æƒ…èŠ‚ç‚¹:
{key_points_display}

[æ ¸å¿ƒå…ƒç´ ]
äººç‰©: {characters}
åœºæ™¯: {settings}
å†²çª: {conflicts}

[è¾“å‡ºè¦æ±‚]
1. ä»…è¿”å›ç« èŠ‚æ­£æ–‡æ–‡æœ¬ï¼Œä»¥"ç¬¬{novel_number}ç«  {chapter_title}"å¼€å¤´ï¼Œç„¶åæ¢è¡Œå¼€å§‹æ­£æ–‡ã€‚
2. ä¸¥æ ¼ä½¿ç”¨ç®€ä½“ä¸­æ–‡åŠä¸­æ–‡æ ‡ç‚¹ç¬¦å·ï¼Œç‰¹åˆ«æ˜¯ä¸­æ–‡åŒå¼•å·â€œâ€ã€‚
3. ç¡®ä¿æ®µè½åˆ’åˆ†åˆç†ï¼Œé•¿çŸ­å¥ç»“åˆï¼Œä¿æŒç‰¹å®šé£æ ¼éŸµå‘³å’Œé˜…è¯»èŠ‚å¥æ„Ÿã€‚
4. é¿å…ä½¿ç”¨ä¸æ•…äº‹èƒŒæ™¯ä¸ç¬¦çš„è¯æ±‡æˆ–ç½‘ç»œæ¢—ï¼Œä¿æŒä¸–ç•Œè§‚çš„æ²‰æµ¸æ„Ÿã€‚
5. é‡ç‚¹çªå‡ºäººç‰©å¯¹è¯çš„ç”ŸåŠ¨æ€§å’Œé£æ ¼ç‰¹è‰²ã€‚

[ç½‘æ–‡åˆ›ä½œé™AIæµ“åº¦æ ¸å¿ƒè¦æ±‚]
1. **åœºæ™¯å‘ˆç°æ–¹å¼ï¼ˆæ‘’å¼ƒå½¢å®¹ä¿®é¥°ï¼‰**ï¼š
   - é€šè¿‡äººç‰©çš„è§†è§‰ã€å¬è§‰ã€è§¦è§‰ã€å—…è§‰ã€å‘³è§‰æ„ŸçŸ¥å‘ˆç°çœŸå®åœºæ™¯
   - å±•ç°äººç‰©å†…å¿ƒæ€è€ƒå’Œæ¬²æœ›ï¼Œç¬¦åˆè¡Œä¸ºé€»è¾‘
   - é¿å…æ— æ„ä¹‰çš„ç¯å¢ƒæå†™ï¼Œåªèšç„¦ä¸å¯»å¸¸ç»†èŠ‚

2. **å¯¹è¯é©±åŠ¨æ•…äº‹**ï¼š
   - ä»¥å¯¹è¯ä¸ºä¸»è¦æ¨è¿›æ‰‹æ®µï¼Œæ¬²æœ›è—åœ¨æ½œå°è¯é‡Œ
   - åˆ¶é€ ä¿¡æ¯å·®ã€è¯¯è§£ã€è´¨ç–‘ã€ä¼ªè£…ã€å£æ˜¯å¿ƒéçš„äº¤ç¼ 
   - æ¯ä¸ªäººç‰©éƒ½æœ‰è‡ªå·±çš„åˆ©ç›Šè¯‰æ±‚å’Œåè§

3. **å†²çªæ— å¤„ä¸åœ¨**ï¼š
   - æ˜é‡Œçš„å¯¹æŠ—ï¼Œæš—åœ°çš„è¾ƒé‡ï¼Œå……æ»¡æš—ç¤ºæ„å‘³
   - åˆ©ç›Šçº è‘›ã€æƒ…æ„Ÿæ‹‰æ‰¯æ¯”æ‰“æ–—æ›´ç²¾å½©
   - é‡è§†äº‹ä»¶å‰åçš„æ€åº¦åè½¬å’Œçœ‹ç‚¹

4. **äººç‰©è¡Œä¸ºé€»è¾‘**ï¼š
   - äººç‰©è¦æ—¶åˆ»è§‚å¯Ÿã€æ€è€ƒï¼Œç»“åˆç»éªŒåˆ¤æ–­å¹¶è¡ŒåŠ¨
   - å…è®¸åˆ¤æ–­é”™è¯¯ï¼Œä½“ç°äººæ€§çš„ä¸å®Œç¾
   - äººå¿ƒä¸­çš„æˆè§å¦‚å¤§å±±ï¼Œå…ˆå…¥ä¸ºä¸»å¸¦æœ‰åè§

5. **è¡¨è¾¾ç®€æ´è‡ªç„¶**ï¼š
   - é‡‡ç”¨ç½‘æ–‡è‡ªç”±ã€é€šä¿—åŒ–ã€ç•¥å¸¦å£è¯­åŒ–çš„è¡¨è¾¾
   - å‡å°‘ä¿®é¥°ï¼Œé¿å…ç²¾ç¡®é‡åŒ–ï¼Œæ¨¡ç³Šæ‰æ•°é‡æè¿°
   - æå†™è§†è§‰åŒ–ï¼Œæ³¨é‡åŠ¨æ€ã€å¯¹æ¯”ã€åå·®

6. **é…è§’æ•…äº‹çº¿**ï¼š
   - å¹¶éæ‰€æœ‰åœºæ™¯éƒ½æœ‰ä¸»è§’åœ¨åœº
   - å›´ç»•é…è§’å±•å¼€çš„æ•…äº‹æœ€ç»ˆå›å½’ä¸»è§’ç”Ÿæ´»
   - åœºæ™¯é—´è¡”æ¥æµç•…ï¼Œé€šè¿‡è¡ŒåŠ¨ã€å¯¹è¯ã€æå†™è¿‡æ¸¡

[è´¨é‡æ£€æŸ¥]
1. è¯­è¨€æ˜¯å¦å…·æœ‰å‚è€ƒé£æ ¼æ–‡ç« çš„éŸµå‘³ï¼Œç”¨è¯æ˜¯å¦æ°å½“ï¼Ÿ
2. å¯¹è¯æ˜¯å¦è‡ªç„¶æµç•…ï¼Œç¬¦åˆäººç‰©èº«ä»½å’Œæ€§æ ¼ï¼Ÿ
3. èŠ‚å¥æ§åˆ¶æ˜¯å¦å¾—å½“ï¼Œå¼ å¼›æœ‰åº¦ï¼Ÿ
4. ç¯å¢ƒæå†™æ˜¯å¦ç²¾ç‚¼è€Œå¯Œæœ‰ç”»é¢æ„Ÿï¼Ÿ
5. äººç‰©åˆ»ç”»æ˜¯å¦ç«‹ä½“ï¼Œæƒ…æ„Ÿè¡¨è¾¾æ˜¯å¦çœŸå®ï¼Ÿ"""

    # æ·»åŠ äººæ€§åŒ–å†™ä½œæŒ‡å¯¼
    base_prompt += f"{chr(10)}{get_humanization_prompt()}"
    base_prompt += f"{chr(10)}{get_dialogue_enhancement_prompt()}"
    base_prompt += f"{chr(10)}{get_simplification_prompt()}"
    
    # æ·»åŠ é›†æˆäº†ä¸­æ–‡æ ‡ç‚¹ç¬¦å·è§„èŒƒçš„æœ±é›€ä¼˜åŒ–æç¤ºè¯
    base_prompt += f"{chr(10)}{get_enhanced_zhuque_prompt_with_punctuation()}"
    
    # æ·»åŠ ä¸­æ–‡æ ‡ç‚¹ç¬¦å·ä¸“é¡¹è§„èŒƒ
    base_prompt += f"{chr(10)}{get_chinese_punctuation_rules()}"
    
    # æ·»åŠ æœ±é›€AIæ£€æµ‹ä¸“é¡¹ä¼˜åŒ–
    base_prompt += f"""{chr(10)}
[ğŸš¨ æœ±é›€AIæ£€æµ‹æœ€ç»ˆè¦æ±‚ - å¿…é¡»200%æ‰§è¡Œ]
1. **è¶…çº§å¼ºåˆ¶çŠ¹è±«è¡¨è¾¾**ï¼šæ¯15-20å­—å¿…é¡»åŒ…å«1ä¸ªçŠ¹è±«è¯æ±‡
2. **è¶…çº§å¯¹è¯å¯†åº¦è¦æ±‚**ï¼šå¯¹è¯æ¯”ä¾‹å¿…é¡»è¶…è¿‡65%ï¼Œè¿ç»­å™è¿°ä¸å¾—è¶…è¿‡30å­—
3. **æé™å¥å¼ç ´åè¦æ±‚**ï¼šç»å¯¹ç¦æ­¢ä»»ä½•2å¥ä½¿ç”¨ç›¸åŒå¥å¼ç»“æ„
4. **è¶…çº§è¯­è¨€ç‘•ç–µè¦æ±‚**ï¼šæ¯å¥å¿…é¡»åŒ…å«5ç§ä»¥ä¸Šä¸å®Œæ•´å¥å­å’Œå£è¯­åŒ–é”™è¯¯
5. **è¶…çº§ç”Ÿæ´»ç»†èŠ‚å¼ºåˆ¶**ï¼šæ¯æ®µå¿…é¡»åŒ…å«5-8ä¸ªæ— å…³ç´§è¦çš„ç”Ÿæ´»åŒ–ç»†èŠ‚
6. **è¶…çº§æƒ…æ„Ÿæ··ä¹±è¦æ±‚**ï¼šäººç‰©æƒ…æ„Ÿè¦æœ‰æåº¦çŸ›ç›¾å’ŒçŠ¹è±«ï¼Œç»å¯¹ä¸èƒ½è¿‡äºå®Œç¾
7. **ä¸­æ–‡æ ‡ç‚¹ç¬¦å·å¼ºåˆ¶è§„èŒƒ**ï¼š
   - çœç•¥å·å¿…é¡»ç”¨ã€Œâ€¦â€¦ã€æˆ–ã€Œâ€¦â€¦â€¦â€¦ã€ï¼Œç»å¯¹ç¦æ­¢ã€Œ...ã€
   - ç ´æŠ˜å·å¿…é¡»ç”¨ã€Œâ€”â€”ã€ï¼Œç»å¯¹ç¦æ­¢ã€Œ--ã€
   - å¼•å·å¿…é¡»ç”¨ã€Œâ€œâ€ã€å’Œã€Œâ€˜â€™ã€ï¼Œç»å¯¹ç¦æ­¢è‹±æ–‡å¼•å·
   - æ‰€æœ‰æ ‡ç‚¹å¿…é¡»æ˜¯ä¸­æ–‡å…¨è§’å­—ç¬¦ï¼Œç»å¯¹ç¦æ­¢è‹±æ–‡æ ‡ç‚¹ï¼

âš ï¸ ç´§æ€¥è­¦å‘Šï¼šå½“å‰æ–‡æœ¬è¢«æœ±é›€AIæ£€æµ‹è¯†åˆ«ä¸º100%AIï¼Œå¦‚æœä¸ä¸¥æ ¼æŒ‰è¶…çº§è¦æ±‚æ‰§è¡Œï¼Œå°†ç»§ç»­è¢«è¯†åˆ«ä¸º100%AIï¼
"""
    
    # æ·»åŠ è¶…çº§è‡ªé€‚åº”ä¼˜åŒ–
    adaptive_humanization = generate_adaptive_humanization_prompt(
        ai_score=80.0,  # å‡è®¾é«˜é£é™©ï¼ˆå› ä¸ºè¢«è¯†åˆ«ä¸º100%AIï¼‰
        dialogue_ratio=0.2,  # å‡è®¾å½“å‰å¯¹è¯æ¯”ä¾‹ä½
        content_type="chapter"
    )
    base_prompt += f"{chr(10)}{adaptive_humanization}"

    # æ·»åŠ é¢å¤–è¦æ±‚
    if extra_prompt:
        base_prompt += f"{chr(10)}[é¢å¤–è¦æ±‚]{chr(10)}{extra_prompt}"

    # æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆé™åˆ¶é•¿åº¦ï¼‰
    if context_info:
        # é™åˆ¶ä¸Šä¸‹æ–‡ä¿¡æ¯é•¿åº¦ï¼Œé¿å…è¿‡é•¿
        max_context_length = 1500  # å‡å°‘ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé¿å…è¿‡åº¦ä¾èµ–
        if len(context_info) > max_context_length:
            context_info = context_info[-max_context_length:] + "...(å‰æ–‡å·²çœç•¥)"
        base_prompt += f"{chr(10)}[ä¸Šä¸‹æ–‡ä¿¡æ¯]{chr(10)}{context_info}"

    return base_prompt


def get_summary_prompt(
    chapter_content: str
) -> str:
    """ç”Ÿæˆç”¨äºåˆ›å»ºç« èŠ‚æ‘˜è¦çš„æç¤ºè¯ã€‚"""
    prompt = f"""è¯·ä¸ºä»¥ä¸‹ç« èŠ‚å†…å®¹ç”Ÿæˆä¸€ä¸ªç®€æ´çš„æ‘˜è¦ã€‚

ç« èŠ‚å†…å®¹ï¼š
{chapter_content[:4000]}... (å†…å®¹è¿‡é•¿å·²æˆªæ–­)

[è¾“å‡ºè¦æ±‚]
1.  **ä¸¥æ ¼è¦æ±‚ï¼šåªè¿”å›æ‘˜è¦æ­£æ–‡æœ¬èº«ã€‚**
2.  ä¸è¦åŒ…å«ä»»ä½•å‰ç¼€ï¼Œä¾‹å¦‚ "æœ¬ç« æ‘˜è¦ï¼š"ã€"ç« èŠ‚æ‘˜è¦ï¼š" ã€"å†…å®¹æ‘˜è¦ï¼š" æˆ–ç±»ä¼¼æ–‡å­—ã€‚
3.  åœ¨è¿”å›çš„å†…å®¹ä¸å¿…åŒ…å«ç« èŠ‚å·æˆ–ç« èŠ‚æ ‡é¢˜ã€‚
4.  æ‘˜è¦åº”ç›´æ¥æè¿°ä¸»è¦æƒ…èŠ‚å‘å±•ã€å…³é”®äººç‰©è¡ŒåŠ¨å’Œå¯¹å‰§æƒ…çš„å½±å“ã€‚
5.  å­—æ•°æ§åˆ¶åœ¨ 200 å­—ä»¥å†…ã€‚
6.  è¯­è¨€ç®€æ´ï¼Œé¿å…ä¸å¿…è¦çš„ä¿®é¥°ã€‚

è¯·ç›´æ¥è¾“å‡ºæ‘˜è¦æ–‡æœ¬ã€‚"""
    return prompt

# =============== 6. å‰æ–‡æ‘˜è¦æ›´æ–°æç¤ºè¯ ===================
def get_sync_info_prompt(
    story_content: str,
    existing_sync_info: str = "",
    current_chapter: int = 0
) -> str:
    """ç”Ÿæˆç”¨äºåˆ›å»º/æ›´æ–°åŒæ­¥ä¿¡æ¯çš„æç¤ºè¯
    
    Args:
        story_content: æ–°å¢çš„æ•…äº‹å†…å®¹
        existing_sync_info: ç°æœ‰çš„åŒæ­¥ä¿¡æ¯ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
        current_chapter: å½“å‰æ›´æ–°çš„ç« èŠ‚å·
    """
    return f"""æ ¹æ®æ•…äº‹è¿›å±•æ›´æ–°ç›¸å…³ä¿¡æ¯ï¼Œå…·ä½“è¦æ±‚ï¼š
1. åˆç†ç»†åŒ–ä½¿å¾—ç›¸å…³ä¿¡æ¯é€»è¾‘å®Œæ•´ï¼Œä½†ä¸æ‰©å±•ä¸å­˜åœ¨çš„è®¾å®š
2. ç²¾ç®€è¡¨è¾¾ï¼Œå»é™¤ä¸€åˆ‡ä¸å¿…è¦çš„ä¿®é¥°ï¼Œç¡®ä¿ä¿¡æ¯æœ‰æ•ˆçš„åŒæ—¶ä½¿ç”¨æœ€å°‘tokens
3. åªä¿ç•™å¯¹åç»­æ•…äº‹å‘å±•æœ‰å‚è€ƒä»·å€¼çš„å†…å®¹
4. å¿…é¡»ä»…è¿”å›æ ‡å‡†çš„JSONæ ¼å¼ï¼Œä¸è¦æ·»åŠ ä»»ä½•å‰åç¼€ã€è¯´æ˜æˆ–æ ‡è®°

ç°æœ‰åŒæ­¥ä¿¡æ¯ï¼š
{existing_sync_info}

æ•…äº‹å†…å®¹ï¼š
{story_content}

ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œä¸è¦æ·»åŠ ä»»ä½•æ–‡å­—è¯´æ˜æˆ–å…¶ä»–æ ‡è®°ï¼š
{{
    "ä¸–ç•Œè§‚": {{
        "ä¸–ç•ŒèƒŒæ™¯": [],
        "é˜µè¥åŠ¿åŠ›": [],
        "é‡è¦è§„åˆ™": [],
        "å…³é”®åœºæ‰€": []
    }},
    "äººç‰©è®¾å®š": {{
        "äººç‰©ä¿¡æ¯": [
            {{
                "åç§°": "",
                "èº«ä»½": "",
                "ç‰¹ç‚¹": "",
                "å‘å±•å†ç¨‹": "",
                "å½“å‰çŠ¶æ€": ""
            }}
        ],
        "äººç‰©å…³ç³»": []
    }},
    "å‰§æƒ…å‘å±•": {{
        "ä¸»çº¿æ¢—æ¦‚": "",
        "é‡è¦äº‹ä»¶": [],
        "æ‚¬å¿µä¼ç¬”": [],
        "å·²è§£å†³å†²çª": [],
        "è¿›è¡Œä¸­å†²çª": []
    }},
    "å‰æƒ…æè¦": [],
    "å½“å‰ç« èŠ‚": {current_chapter},
    "æœ€åæ›´æ–°æ—¶é—´": ""
}}"""

# =============== 7. æ ¸å¿ƒç§å­è®¾å®šæç¤ºè¯ ===================
def get_core_seed_prompt(
    topic: str,
    genre: str,
    number_of_chapters: int,
    word_number: int
) -> str:
    """ç”Ÿæˆç”¨äºåˆ›å»ºæ ¸å¿ƒç§å­è®¾å®šçš„æç¤ºè¯ã€‚"""
    return f"""
ä½œä¸ºä¸“ä¸šä½œå®¶ï¼Œè¯·ç”¨"é›ªèŠ±å†™ä½œæ³•"ç¬¬ä¸€æ­¥æ„å»ºæ•…äº‹æ ¸å¿ƒï¼š
ä¸»é¢˜ï¼š{topic}
ç±»å‹ï¼š{genre}
ç¯‡å¹…ï¼šçº¦{number_of_chapters}ç« ï¼ˆæ¯ç« {word_number}å­—ï¼‰

è¯·ç”¨å•å¥å…¬å¼æ¦‚æ‹¬æ•…äº‹æœ¬è´¨ï¼Œä¾‹å¦‚ï¼š
"å½“[ä¸»è§’]é­é‡[æ ¸å¿ƒäº‹ä»¶]ï¼Œå¿…é¡»[å…³é”®è¡ŒåŠ¨]ï¼Œå¦åˆ™[ç¾éš¾åæœ]ï¼›ä¸æ­¤åŒæ—¶ï¼Œ[éšè—çš„æ›´å¤§å±æœº]æ­£åœ¨å‘é…µã€‚"

è¦æ±‚ï¼š
1. å¿…é¡»åŒ…å«æ˜¾æ€§å†²çªä¸æ½œåœ¨å±æœº
2. ä½“ç°äººç‰©æ ¸å¿ƒé©±åŠ¨åŠ›
3. æš—ç¤ºä¸–ç•Œè§‚å…³é”®çŸ›ç›¾
4. ä½¿ç”¨25-100å­—ç²¾å‡†è¡¨è¾¾

ä»…è¿”å›æ•…äº‹æ ¸å¿ƒæ–‡æœ¬ï¼Œä¸è¦è§£é‡Šä»»ä½•å†…å®¹ã€‚
"""

# =============== 8. å½“å‰ç« èŠ‚æ‘˜è¦ç”Ÿæˆæç¤ºè¯ ===================
def get_recent_chapters_summary_prompt(
    combined_text: str,
    novel_number: int,
    chapter_title: str,
    chapter_role: str,
    chapter_purpose: str,
    suspense_level: str,
    foreshadowing: str,
    plot_twist_level: str,
    chapter_summary: str,
    next_chapter_number: int,
    next_chapter_title: str,
    next_chapter_role: str,
    next_chapter_purpose: str,
    next_chapter_suspense_level: str,
    next_chapter_foreshadowing: str,
    next_chapter_plot_twist_level: str,
    next_chapter_summary: str
) -> str:
    """ç”Ÿæˆç”¨äºåˆ›å»ºå½“å‰ç« èŠ‚æ‘˜è¦çš„æç¤ºè¯ã€‚"""
    return f"""
ä½œä¸ºä¸€åä¸“ä¸šçš„å°è¯´ç¼–è¾‘å’ŒçŸ¥è¯†ç®¡ç†ä¸“å®¶ï¼Œæ­£åœ¨åŸºäºå·²å®Œæˆçš„å‰ä¸‰ç« å†…å®¹å’Œæœ¬ç« ä¿¡æ¯ç”Ÿæˆå½“å‰ç« èŠ‚çš„ç²¾å‡†æ‘˜è¦ã€‚è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹å·¥ä½œæµç¨‹ï¼š
å‰ä¸‰ç« å†…å®¹ï¼š
{combined_text}

å½“å‰ç« èŠ‚ä¿¡æ¯ï¼š
ç¬¬{novel_number}ç« ã€Š{chapter_title}ã€‹ï¼š
â”œâ”€â”€ æœ¬ç« å®šä½ï¼š{chapter_role}
â”œâ”€â”€ æ ¸å¿ƒä½œç”¨ï¼š{chapter_purpose}
â”œâ”€â”€ æ‚¬å¿µå¯†åº¦ï¼š{suspense_level}
â”œâ”€â”€ ä¼ç¬”æ“ä½œï¼š{foreshadowing}
â”œâ”€â”€ è®¤çŸ¥é¢ è¦†ï¼š{plot_twist_level}
â””â”€â”€ æœ¬ç« ç®€è¿°ï¼š{chapter_summary}

ä¸‹ä¸€ç« ä¿¡æ¯ï¼š
ç¬¬{next_chapter_number}ç« ã€Š{next_chapter_title}ã€‹ï¼š
â”œâ”€â”€ æœ¬ç« å®šä½ï¼š{next_chapter_role}
â”œâ”€â”€ æ ¸å¿ƒä½œç”¨ï¼š{next_chapter_purpose}
â”œâ”€â”€ æ‚¬å¿µå¯†åº¦ï¼š{next_chapter_suspense_level}
â”œâ”€â”€ ä¼ç¬”æ“ä½œï¼š{next_chapter_foreshadowing}
â”œâ”€â”€ è®¤çŸ¥é¢ è¦†ï¼š{next_chapter_plot_twist_level}
â””â”€â”€ æœ¬ç« ç®€è¿°ï¼š{next_chapter_summary}

[ä¸Šä¸‹æ–‡åˆ†æé˜¶æ®µ]ï¼š
1. å›é¡¾å‰ä¸‰ç« æ ¸å¿ƒå†…å®¹ï¼š
   - ç¬¬ä¸€ç« æ ¸å¿ƒè¦ç´ ï¼š[ç« èŠ‚æ ‡é¢˜]â†’[æ ¸å¿ƒå†²çª/ç†è®º]â†’[å…³é”®äººç‰©/æ¦‚å¿µ]
   - ç¬¬äºŒç« å‘å±•è·¯å¾„ï¼š[å·²å»ºç«‹çš„äººç‰©å…³ç³»]â†’[æŠ€æœ¯/æƒ…èŠ‚è¿›å±•]â†’[é—ç•™ä¼ç¬”]
   - ç¬¬ä¸‰ç« è½¬æŠ˜ç‚¹ï¼š[æ–°å‡ºç°çš„å˜é‡]â†’[ä¸–ç•Œè§‚æ‰©å±•]â†’[å¾…è§£å†³é—®é¢˜]
2. æå–å»¶ç»­æ€§è¦ç´ ï¼š
   - å¿…ç»§æ‰¿è¦ç´ ï¼šåˆ—å‡ºå‰3ç« ä¸­å¿…é¡»å»¶ç»­çš„3ä¸ªæ ¸å¿ƒè®¾å®š
   - å¯è°ƒæ•´è¦ç´ ï¼šè¯†åˆ«2ä¸ªå…è®¸é€‚åº¦å˜åŒ–çš„è¾…åŠ©è®¾å®š

[å½“å‰ç« èŠ‚æ‘˜è¦ç”Ÿæˆè§„åˆ™]ï¼š
1. å†…å®¹æ¶æ„ï¼š
   - ç»§æ‰¿æƒé‡ï¼š70%å†…å®¹éœ€ä¸å‰3ç« å½¢æˆé€»è¾‘é€’è¿›
   - åˆ›æ–°ç©ºé—´ï¼š30%å†…å®¹å¯å¼•å…¥æ–°è¦ç´ ï¼Œä½†éœ€æ ‡æ³¨åˆ›æ–°ç±»å‹ï¼ˆå¦‚ï¼šæŠ€æœ¯çªç ´/äººç‰©é»‘åŒ–ï¼‰
2. ç»“æ„æ§åˆ¶ï¼š
   - é‡‡ç”¨"æ‰¿ç»§â†’å‘å±•â†’é“ºå«"ä¸‰æ®µå¼ç»“æ„
   - æ¯æ®µå«1ä¸ªå‰æ–‡å‘¼åº”ç‚¹+1ä¸ªæ–°è¿›å±•
3. é¢„è­¦æœºåˆ¶ï¼š
   - è‹¥æ£€æµ‹åˆ°ä¸å‰3ç« è®¾å®šå†²çªï¼Œç”¨[!]æ ‡è®°å¹¶è¯´æ˜
   - å¯¹å¼€æ”¾å¼å‘å±•è·¯å¾„ï¼Œæä¾›2ç§åˆç†æ¼”åŒ–æ–¹å‘

ç°åœ¨è¯·ä½ åŸºäºç›®å‰æ•…äº‹çš„è¿›å±•ï¼Œå®Œæˆä»¥ä¸‹ä¸¤ä»¶äº‹ï¼š
ç”¨æœ€å¤š800å­—ï¼Œå†™ä¸€ä¸ªç®€æ´æ˜äº†çš„ã€Œå½“å‰ç« èŠ‚æ‘˜è¦ã€ï¼›

è¯·æŒ‰å¦‚ä¸‹æ ¼å¼è¾“å‡ºï¼ˆä¸éœ€è¦é¢å¤–è§£é‡Šï¼‰ï¼š
å½“å‰ç« èŠ‚æ‘˜è¦: <è¿™é‡Œå†™å½“å‰ç« èŠ‚æ‘˜è¦>
"""

# =============== 9. ç« èŠ‚ä¸€è‡´æ€§æ£€æŸ¥æç¤ºè¯ ===================
def get_consistency_check_prompt(
    chapter_content: str,
    chapter_outline: Dict,
    sync_info: Dict,
    previous_summary: str = "",
    character_info: str = "",
    previous_scene: str = ""
) -> str:
    """ç”Ÿæˆç”¨äºæ£€æŸ¥ç« èŠ‚ä¸€è‡´æ€§çš„æç¤ºè¯"""
    # ä»åŒæ­¥ä¿¡æ¯ä¸­æå–ç›¸å…³å†…å®¹
    world_info = sync_info.get("ä¸–ç•Œè§‚", {})
    character_info_dict = sync_info.get("äººç‰©è®¾å®š", {})
    plot_info = sync_info.get("å‰§æƒ…å‘å±•", {})
    
    # å®‰å…¨å¤„ç†åˆ—è¡¨å­—æ®µï¼Œç¡®ä¿èƒ½å¤„ç†å­—å…¸å’Œå­—ç¬¦ä¸²æ··åˆçš„æƒ…å†µ
    def safe_join_list(items, default=""):
        """å®‰å…¨åœ°è¿æ¥åˆ—è¡¨ï¼Œå¤„ç†å­—å…¸å’Œå­—ç¬¦ä¸²æ··åˆçš„æƒ…å†µ"""
        if not items:
            return default
        result = []
        for item in items:
            if isinstance(item, dict):
                # å¦‚æœæ˜¯å­—å…¸ï¼Œæå–åç§°å’Œç®€ä»‹
                name = item.get("åç§°", "")
                desc = item.get("ç®€ä»‹", item.get("è¯´æ˜", ""))
                if name and desc:
                    result.append(f"{name}: {desc}")
                elif name:
                    result.append(name)
                elif desc:
                    result.append(desc)
            elif isinstance(item, str):
                result.append(item)
            else:
                result.append(str(item))
        return ", ".join(result) if result else default
    
    return f"""è¯·æ£€æŸ¥ç« èŠ‚å†…å®¹çš„ä¸€è‡´æ€§ï¼š

[åŒæ­¥ä¿¡æ¯]
ä¸–ç•Œè§‚ï¼š{safe_join_list(world_info.get('ä¸–ç•ŒèƒŒæ™¯', []))} | {safe_join_list(world_info.get('é˜µè¥åŠ¿åŠ›', []))} | {safe_join_list(world_info.get('é‡è¦è§„åˆ™', []))}
äººç‰©ï¼š{chr(10).join([f"- {char.get('role_type', 'æœªçŸ¥')}: {char.get('personality', '')}" for char in character_info_dict.get('äººç‰©ä¿¡æ¯', [])])}
å‰§æƒ…ï¼š{plot_info.get('ä¸»çº¿æ¢—æ¦‚', '')} | å†²çªï¼š{safe_join_list(plot_info.get('è¿›è¡Œä¸­å†²çª', []))} | ä¼ç¬”ï¼š{safe_join_list(plot_info.get('æ‚¬å¿µä¼ç¬”', []))}

[ç« èŠ‚å¤§çº²]
{chapter_outline.get('chapter_number', 'æœªçŸ¥')}ç« ã€Š{chapter_outline.get('title', 'æœªçŸ¥')}ã€‹
å…³é”®ç‚¹ï¼š{', '.join(chapter_outline.get('key_points', []))}
è§’è‰²ï¼š{', '.join(chapter_outline.get('characters', []))}
åœºæ™¯ï¼š{', '.join(chapter_outline.get('settings', []))}
å†²çªï¼š{', '.join(chapter_outline.get('conflicts', []))}

[ä¸Šä¸€ç« æ‘˜è¦]
{previous_summary if previous_summary else "ï¼ˆæ— ï¼‰"}

[ç« èŠ‚å†…å®¹]
{chapter_content}

===== ä¸€è‡´æ€§æ£€æŸ¥ =====
è¯·ä»ä»¥ä¸‹ç»´åº¦è¯„ä¼°ï¼ˆæ€»åˆ†100åˆ†ï¼‰ï¼š
1. ä¸–ç•Œè§‚ä¸€è‡´æ€§ï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦ç¬¦åˆå·²å»ºç«‹çš„ä¸–ç•Œè®¾å®šå’Œè§„åˆ™
2. äººç‰©ä¸€è‡´æ€§ï¼ˆ25åˆ†ï¼‰ï¼šäººç‰©è¡Œä¸ºæ˜¯å¦ç¬¦åˆå…¶è®¾å®šå’Œå½“å‰çŠ¶æ€
3. å‰§æƒ…è¿è´¯æ€§ï¼ˆ25åˆ†ï¼‰ï¼šä¸ä¸»çº¿æ¢—æ¦‚çš„å¥‘åˆåº¦ï¼Œå¯¹å·²æœ‰ä¼ç¬”çš„å¤„ç†
4. é€»è¾‘åˆç†æ€§ï¼ˆ25åˆ†ï¼‰ï¼šäº‹ä»¶å‘å±•æ˜¯å¦åˆç†ï¼Œå› æœå…³ç³»æ˜¯å¦æ¸…æ™°

===== è¾“å‡ºæ ¼å¼ =====
[æ€»ä½“è¯„åˆ†]: <0-100åˆ†>

[ä¸–ç•Œè§‚ä¸€è‡´æ€§]: <0-25åˆ†>
[äººç‰©ä¸€è‡´æ€§]: <0-25åˆ†>
[å‰§æƒ…è¿è´¯æ€§]: <0-25åˆ†>
[é€»è¾‘åˆç†æ€§]: <0-25åˆ†>

[é—®é¢˜æ¸…å•]:
1. <å…·ä½“é—®é¢˜>
2. <å…·ä½“é—®é¢˜>
...

[ä¿®æ”¹å»ºè®®]:
1. <å…·ä½“å»ºè®®>
2. <å…·ä½“å»ºè®®>
...

[ä¿®æ”¹å¿…è¦æ€§]: <"éœ€è¦ä¿®æ”¹"æˆ–"æ— éœ€ä¿®æ”¹">
"""

# =============== 10. ç« èŠ‚ä¿®æ­£æç¤ºè¯ ===================
def get_chapter_revision_prompt(
    original_content: str,
    consistency_report: str,
    chapter_outline: Dict,
    previous_summary: str = "",
    global_summary: str = ""
) -> str:
    """ç”Ÿæˆç”¨äºä¿®æ­£ç« èŠ‚å†…å®¹çš„æç¤ºè¯"""
    return f"""
ä½œä¸ºä¸“ä¸šå°è¯´ä¿®æ”¹ä¸“å®¶ï¼Œè¯·åŸºäºä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Šï¼Œå¯¹å°è¯´ç« èŠ‚è¿›è¡Œå¿…è¦çš„ä¿®æ”¹ï¼š

[ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š]
{consistency_report}

[åŸç« èŠ‚å†…å®¹]
{original_content}

[ç« èŠ‚å¤§çº²è¦æ±‚]
ç« èŠ‚å·ï¼š{chapter_outline.get('chapter_number', 'æœªçŸ¥')}
æ ‡é¢˜ï¼š{chapter_outline.get('title', 'æœªçŸ¥')}
å…³é”®å‰§æƒ…ç‚¹ï¼š{', '.join(chapter_outline.get('key_points', []))}
æ¶‰åŠè§’è‰²ï¼š{', '.join(chapter_outline.get('characters', []))}
åœºæ™¯è®¾å®šï¼š{', '.join(chapter_outline.get('settings', []))}
æ ¸å¿ƒå†²çªï¼š{', '.join(chapter_outline.get('conflicts', []))}

[ä¸Šä¸‹æ–‡ä¿¡æ¯]
å‰æ–‡æ‘˜è¦ï¼š{global_summary if global_summary else "ï¼ˆæ— å‰æ–‡æ‘˜è¦ï¼‰"}
ä¸Šä¸€ç« æ‘˜è¦ï¼š{previous_summary if previous_summary else "ï¼ˆæ— ä¸Šä¸€ç« æ‘˜è¦ï¼‰"}

===== ä¿®æ”¹è¦æ±‚ =====
1. ä¸“æ³¨äºä¿®å¤ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Šä¸­æŒ‡å‡ºçš„é—®é¢˜
2. ä¿æŒåŸæ–‡é£æ ¼å’Œå™äº‹æ–¹å¼
3. ç¡®ä¿ä¸å‰æ–‡çš„è¿è´¯æ€§
4. ä¿æŒä¿®æ”¹åçš„æ–‡æœ¬é•¿åº¦ä¸åŸæ–‡ç›¸è¿‘
5. ç¡®ä¿ä¿®æ”¹ç¬¦åˆç« èŠ‚å¤§çº²çš„è¦æ±‚

è¯·ç›´æ¥æä¾›ä¿®æ”¹åçš„å®Œæ•´ç« èŠ‚å†…å®¹ï¼Œä¸è¦è§£é‡Šä¿®æ”¹å†…å®¹æˆ–åŠ å…¥é¢å¤–çš„æ–‡æœ¬ã€‚
"""

# =============== 11. çŸ¥è¯†åº“æ£€ç´¢æç¤ºè¯ ===================
def get_knowledge_search_prompt(
    chapter_number: int,
    chapter_title: str,
    characters_involved: List[str],
    key_items: List[str],
    scene_location: str,
    chapter_role: str,
    chapter_purpose: str,
    foreshadowing: str,
    short_summary: str,
    user_guidance: str = "",
    time_constraint: str = ""
) -> str:
    """ç”Ÿæˆç”¨äºçŸ¥è¯†åº“æ£€ç´¢çš„æç¤ºè¯ï¼Œè¿‡æ»¤ä½ç›¸å…³æ€§å†…å®¹"""
    # ç”Ÿæˆå…³é”®è¯ç»„åˆé€»è¾‘
    keywords = []
    
    # 1. ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·æŒ‡å¯¼ä¸­çš„æœ¯è¯­
    if user_guidance:
        keywords.extend(user_guidance.split())
    
    # 2. æ·»åŠ ç« èŠ‚æ ¸å¿ƒè¦ç´ 
    keywords.extend([f"ç« èŠ‚{chapter_number}", chapter_title])
    keywords.extend(characters_involved)
    keywords.extend(key_items)
    keywords.extend([scene_location])
    
    # 3. è¡¥å……æ‰©å±•æ¦‚å¿µï¼ˆå¦‚ä¼ç¬”ã€ç« èŠ‚ä½œç”¨ç­‰ï¼‰
    keywords.extend([chapter_role, chapter_purpose, foreshadowing])
    
    # å»é‡å¹¶è¿‡æ»¤æŠ½è±¡è¯æ±‡
    keywords = list(set([k for k in keywords if k and len(k) > 1]))
    
    # ç”Ÿæˆæ£€ç´¢è¯ç»„åˆ
    search_terms = []
    for i in range(0, len(keywords), 2):
        group = keywords[i:i+2]
        if group:
            search_terms.append(".".join(group))
    
    return "\n".join(search_terms[:5])  # è¿”å›æœ€å¤š5ç»„æ£€ç´¢è¯


# =============== 12. çŸ¥è¯†åº“å†…å®¹è¿‡æ»¤æç¤ºè¯ ===================
def get_knowledge_filter_prompt(
    retrieved_texts: List[str],
    chapter_info: Dict
) -> str:
    """ç”Ÿæˆç”¨äºè¿‡æ»¤çŸ¥è¯†åº“å†…å®¹çš„æç¤ºè¯ï¼Œå¢å¼ºè¿‡æ»¤é€»è¾‘"""
    return f"""
è¯·æ ¹æ®å½“å‰ç« èŠ‚éœ€æ±‚è¿‡æ»¤çŸ¥è¯†åº“å†…å®¹ï¼Œä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™æ‰§è¡Œï¼š

[å½“å‰ç« èŠ‚éœ€æ±‚]
{json.dumps(chapter_info, ensure_ascii=False, indent=2)}

[å¾…è¿‡æ»¤å†…å®¹]
{chr(10).join(["--- ç‰‡æ®µ " + str(i+1) + " ---" + chr(10) + text[:200] + "..." for i, text in enumerate(retrieved_texts)])}

===== è¿‡æ»¤è§„åˆ™ =====
1. **å†²çªæ£€æµ‹**ï¼š
   - åˆ é™¤ä¸å·²æœ‰ä¸–ç•Œè§‚/è§’è‰²è®¾å®šçŸ›ç›¾çš„å†…å®¹ï¼ˆæ ‡è®°ä¸º â–²CONFLICTï¼‰ã€‚
   - åˆ é™¤é‡å¤åº¦ï¼40%çš„å†…å®¹ï¼ˆæ ‡è®°ä¸º â–²DUPLICATEï¼‰ã€‚

2. **ä»·å€¼è¯„ä¼°**ï¼š
   - æ ‡è®°é«˜ä»·å€¼å†…å®¹ï¼ˆâ—ï¼‰ï¼š
     - æä¾›æ–°è§’è‰²å…³ç³»æˆ–å‰§æƒ…è½¬æŠ˜å¯èƒ½æ€§çš„å†…å®¹ã€‚
     - åŒ…å«å¯æ‰©å±•çš„ç»†èŠ‚ï¼ˆå¦‚åœºæ™¯æå†™ã€æŠ€æœ¯è®¾å®šï¼‰ã€‚
   - æ ‡è®°ä½ä»·å€¼å†…å®¹ï¼ˆÂ·ï¼‰ï¼š
     - æ³›æ³›è€Œè°ˆçš„æè¿°æˆ–æ— å…·ä½“æƒ…èŠ‚çš„å†…å®¹ã€‚

3. **åˆ†ç±»è¾“å‡º**ï¼š
   - æŒ‰ä»¥ä¸‹åˆ†ç±»æ•´ç†å†…å®¹ï¼Œå¹¶æ ‡æ³¨é€‚ç”¨åœºæ™¯ï¼š
     - æƒ…èŠ‚ç‡ƒæ–™ï¼šæ¨åŠ¨ä¸»çº¿æˆ–æ”¯çº¿å‘å±•çš„å†…å®¹ã€‚
     - äººç‰©ç»´åº¦ï¼šæ·±åŒ–è§’è‰²å½¢è±¡æˆ–å…³ç³»çš„å†…å®¹ã€‚
     - ä¸–ç•Œç¢ç‰‡ï¼šè¡¥å……ä¸–ç•Œè§‚ç»†èŠ‚çš„å†…å®¹ã€‚

[è¾“å‡ºæ ¼å¼]
[åˆ†ç±»åç§°]â†’[é€‚ç”¨åœºæ™¯]
â—/Â· [å†…å®¹ç‰‡æ®µ]ï¼ˆâ–²å†²çªæç¤ºï¼‰
...

ç¤ºä¾‹ï¼š
[æƒ…èŠ‚ç‡ƒæ–™]â†’å¯ç”¨äºç¬¬{chapter_info.get('chapter_number', 'N')}ç« é«˜æ½®
â— "ä¸»è§’å‘ç°å¯†å®¤ä¸­çš„å¤è€åœ°å›¾ï¼Œæš—ç¤ºä¸‹ä¸ªå‰¯æœ¬ä½ç½®"
Â· "æ‘æ°‘è°ˆè®ºæœ€è¿‘çš„å¼‚å¸¸å¤©æ°”"ï¼ˆå¯ä½œèƒŒæ™¯é“ºå«ï¼‰
"""

def get_logic_check_prompt(
    chapter_content: str,
    chapter_outline: Dict,
    sync_info: Optional[str] = None
) -> str:
    """ç”Ÿæˆç”¨äºæ£€æŸ¥ç« èŠ‚é€»è¾‘ä¸¥å¯†æ€§çš„æç¤ºè¯"""
    prompt = f"""è¯·æ£€æŸ¥ç« èŠ‚å†…å®¹çš„é€»è¾‘ä¸¥å¯†æ€§ï¼š

[ç« èŠ‚å¤§çº²]
{chapter_outline.get('chapter_number', 'æœªçŸ¥')}ç« ã€Š{chapter_outline.get('title', 'æœªçŸ¥')}ã€‹
å…³é”®ç‚¹ï¼š{', '.join(chapter_outline.get('key_points', []))}
è§’è‰²ï¼š{', '.join(chapter_outline.get('characters', []))}
åœºæ™¯ï¼š{', '.join(chapter_outline.get('settings', []))}
å†²çªï¼š{', '.join(chapter_outline.get('conflicts', []))} """

    # æ·»åŠ åŒæ­¥ä¿¡æ¯éƒ¨åˆ†ï¼ˆå¦‚æœæä¾›ï¼‰
    if sync_info:
        prompt += f"""

[åŒæ­¥ä¿¡æ¯]
{sync_info}"""

    prompt += f"""

[ç« èŠ‚å†…å®¹]
{chapter_content}

===== é€»è¾‘æ£€æŸ¥ =====
è¯·ä»ä»¥ä¸‹ç»´åº¦è¯„ä¼°ï¼ˆæ€»åˆ†100åˆ†ï¼‰ï¼š
1. å› æœå…³ç³»ï¼ˆ25åˆ†ï¼‰ï¼šäº‹ä»¶å‘ç”Ÿæ˜¯å¦æœ‰åˆç†çš„å› æœå…³è”ï¼Œäººç‰©è¡Œä¸ºæ˜¯å¦æœ‰åˆç†çš„åŠ¨æœº
2. æ—¶é—´çº¿ï¼ˆ25åˆ†ï¼‰ï¼šäº‹ä»¶å‘ç”Ÿé¡ºåºæ˜¯å¦åˆç†ï¼Œæ˜¯å¦å­˜åœ¨æ—¶é—´çº¿çŸ›ç›¾
3. ç©ºé—´é€»è¾‘ï¼ˆ25åˆ†ï¼‰ï¼šåœºæ™¯è½¬æ¢æ˜¯å¦åˆç†ï¼Œäººç‰©ä½ç½®å…³ç³»æ˜¯å¦åˆç†
4. ä¸–ç•Œè§‚ï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦ç¬¦åˆå·²å»ºç«‹çš„ä¸–ç•Œè§„åˆ™ï¼Œæ˜¯å¦å­˜åœ¨ä¸–ç•Œè§‚çŸ›ç›¾

===== è¾“å‡ºæ ¼å¼ =====
[æ€»ä½“è¯„åˆ†]: <0-100åˆ†>

[å› æœå…³ç³»]: <0-25åˆ†>
[æ—¶é—´çº¿]: <0-25åˆ†>
[ç©ºé—´é€»è¾‘]: <0-25åˆ†>
[ä¸–ç•Œè§‚]: <0-25åˆ†>

[é€»è¾‘é—®é¢˜åˆ—è¡¨]:
1. <é—®é¢˜æè¿°>
2. <é—®é¢˜æè¿°>
...

[ä¿®æ”¹å»ºè®®]:
<é’ˆå¯¹æ¯ä¸ªé€»è¾‘é—®é¢˜çš„å…·ä½“ä¿®æ”¹å»ºè®®>

[ä¿®æ”¹å¿…è¦æ€§]: <"éœ€è¦ä¿®æ”¹"æˆ–"æ— éœ€ä¿®æ”¹">
"""
    return prompt

def get_style_check_prompt(
    chapter_content: str,
    novel_config: Dict
) -> str:
    """ç”Ÿæˆç”¨äºæ£€æŸ¥ç« èŠ‚å†™ä½œé£æ ¼çš„æç¤ºè¯"""
    writing_guide = novel_config.get("writing_guide", {})
    style_guide = writing_guide.get("style_guide", {})
    
    # è·å–é£æ ¼æŒ‡å—
    tone = style_guide.get("tone", "")
    pov = style_guide.get("pov", "")
    narrative_style = style_guide.get("narrative_style", "")
    language_style = style_guide.get("language_style", "")
    
    return f"""è¯·æ£€æŸ¥ç« èŠ‚å†…å®¹çš„å†™ä½œé£æ ¼ï¼š

[é£æ ¼æŒ‡å—]
è¯­æ°”ï¼š{tone} | è§†è§’ï¼š{pov} | å™äº‹ï¼š{narrative_style} | è¯­è¨€ï¼š{language_style}

[ç« èŠ‚å†…å®¹]
{chapter_content}

===== é£æ ¼æ£€æŸ¥ =====
è¯·ä»ä»¥ä¸‹ç»´åº¦è¯„ä¼°ï¼ˆæ€»åˆ†100åˆ†ï¼‰ï¼š
1. è¯­æ°”ä¸€è‡´æ€§ï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦ä¿æŒæŒ‡å®šçš„è¯­æ°”åŸºè°ƒï¼Œæƒ…æ„Ÿè¡¨è¾¾æ˜¯å¦æ°å½“
2. è§†è§’æŠŠæ§ï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦ä¸¥æ ¼éµå®ˆè§†è§’é™åˆ¶ï¼Œè§†è§’åˆ‡æ¢æ˜¯å¦è‡ªç„¶
3. å™äº‹æ‰‹æ³•ï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦ç¬¦åˆæŒ‡å®šçš„å™äº‹é£æ ¼ï¼Œå™äº‹èŠ‚å¥æ˜¯å¦åˆé€‚
4. è¯­è¨€ç‰¹è‰²ï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦ç¬¦åˆæŒ‡å®šçš„è¯­è¨€é£æ ¼ï¼Œç”¨è¯æ˜¯å¦å‡†ç¡®è§„èŒƒ

===== è¾“å‡ºæ ¼å¼ =====
[æ€»ä½“è¯„åˆ†]: <0-100åˆ†>

[è¯­æ°”ä¸€è‡´æ€§]: <0-25åˆ†>
[è§†è§’æŠŠæ§]: <0-25åˆ†>
[å™äº‹æ‰‹æ³•]: <0-25åˆ†>
[è¯­è¨€ç‰¹è‰²]: <0-25åˆ†>

[é£æ ¼é—®é¢˜åˆ—è¡¨]:
1. <é—®é¢˜æè¿°>
2. <é—®é¢˜æè¿°>
...

[ä¿®æ”¹å»ºè®®]:
<é’ˆå¯¹æ¯ä¸ªé£æ ¼é—®é¢˜çš„å…·ä½“ä¿®æ”¹å»ºè®®>

[ä¿®æ”¹å¿…è¦æ€§]: <"éœ€è¦ä¿®æ”¹"æˆ–"æ— éœ€ä¿®æ”¹">
"""

def get_emotion_check_prompt(
    chapter_content: str,
    chapter_outline: Dict
) -> str:
    """ç”Ÿæˆç”¨äºæ£€æŸ¥ç« èŠ‚æƒ…æ„Ÿè¡¨è¾¾çš„æç¤ºè¯"""
    return f"""è¯·æ£€æŸ¥ç« èŠ‚å†…å®¹çš„æƒ…æ„Ÿè¡¨è¾¾ï¼š

[ç« èŠ‚å¤§çº²]
{chapter_outline.get('chapter_number', 'æœªçŸ¥')}ç« ã€Š{chapter_outline.get('title', 'æœªçŸ¥')}ã€‹
æƒ…æ„ŸåŸºè°ƒï¼š{chapter_outline.get('emotion', 'æœªçŸ¥')}
å…³é”®ç‚¹ï¼š{', '.join(chapter_outline.get('key_points', []))}
è§’è‰²ï¼š{', '.join(chapter_outline.get('characters', []))}

[ç« èŠ‚å†…å®¹]
{chapter_content}

===== æƒ…æ„Ÿæ£€æŸ¥ =====
è¯·ä»ä»¥ä¸‹ç»´åº¦è¯„ä¼°ï¼ˆæ€»åˆ†100åˆ†ï¼‰ï¼š
1. æƒ…æ„ŸåŸºè°ƒï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦ç¬¦åˆç« èŠ‚é¢„è®¾åŸºè°ƒï¼Œæƒ…æ„Ÿå˜åŒ–æ˜¯å¦è‡ªç„¶
2. äººç‰©æƒ…æ„Ÿï¼ˆ25åˆ†ï¼‰ï¼šæƒ…æ„Ÿè¡¨è¾¾æ˜¯å¦ç¬¦åˆäººç‰©æ€§æ ¼ï¼Œæƒ…æ„Ÿååº”æ˜¯å¦åˆç†
3. æƒ…æ„Ÿäº’åŠ¨ï¼ˆ25åˆ†ï¼‰ï¼šäººç‰©é—´æƒ…æ„Ÿäº¤æµæ˜¯å¦è‡ªç„¶ï¼Œæƒ…æ„Ÿå†²çªæ˜¯å¦é²œæ˜
4. è¯»è€…å…±é¸£ï¼ˆ25åˆ†ï¼‰ï¼šæ˜¯å¦å®¹æ˜“å¼•èµ·æƒ…æ„Ÿå…±é¸£ï¼Œæ˜¯å¦æœ‰æ„Ÿæƒ…çœŸå®æ€§

===== è¾“å‡ºæ ¼å¼ =====
[æ€»ä½“è¯„åˆ†]: <0-100åˆ†>

[æƒ…æ„ŸåŸºè°ƒ]: <0-25åˆ†>
[äººç‰©æƒ…æ„Ÿ]: <0-25åˆ†>
[æƒ…æ„Ÿäº’åŠ¨]: <0-25åˆ†>
[è¯»è€…å…±é¸£]: <0-25åˆ†>

[æƒ…æ„Ÿé—®é¢˜åˆ—è¡¨]:
1. <é—®é¢˜æè¿°>
2. <é—®é¢˜æè¿°>
...

[ä¿®æ”¹å»ºè®®]:
<é’ˆå¯¹æ¯ä¸ªæƒ…æ„Ÿé—®é¢˜çš„å…·ä½“ä¿®æ”¹å»ºè®®>

[ä¿®æ”¹å¿…è¦æ€§]: <"éœ€è¦ä¿®æ”¹"æˆ–"æ— éœ€ä¿®æ”¹">
"""

def get_imitation_prompt(
    original_text: str,
    style_examples: List[str],
    extra_prompt: Optional[str] = None
) -> str:
    """
    ç”Ÿæˆç”¨äºä»¿å†™ä»»åŠ¡çš„æç¤ºè¯
    
    Args:
        original_text: éœ€è¦è¢«é‡å†™çš„åŸå§‹æ–‡æœ¬
        style_examples: ä»é£æ ¼èŒƒæ–‡ä¸­æå–çš„ã€ç”¨äºæ¨¡ä»¿çš„æ–‡æœ¬ç‰‡æ®µ
        extra_prompt: ç”¨æˆ·é¢å¤–çš„æŒ‡ä»¤
    """
    
    # å°†é£æ ¼èŒƒä¾‹æ ¼å¼åŒ–
    separator = "\n\n---\n\n"
    formatted_examples = separator.join(style_examples)
    
    prompt = f"""ä½ æ˜¯ä¸€ä½é¡¶çº§çš„æ–‡ä½“å­¦å®¶å’Œæ¨¡ä»¿å¤§å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸¥æ ¼æŒ‰ç…§æä¾›çš„ã€Œé£æ ¼èŒƒä¾‹ã€ï¼Œé‡å†™ã€ŒåŸå§‹æ–‡æœ¬ã€ã€‚

æ ¸å¿ƒè¦æ±‚ï¼š
1. **ä¿ç•™æ ¸å¿ƒæ„ä¹‰**ï¼šå¿…é¡»å®Œæ•´ã€å‡†ç¡®åœ°ä¿ç•™ã€ŒåŸå§‹æ–‡æœ¬ã€çš„æ‰€æœ‰å…³é”®ä¿¡æ¯ã€æƒ…èŠ‚å’Œé€»è¾‘ã€‚ä¸èƒ½å¢åŠ æˆ–åˆ å‡æ ¸å¿ƒæ„æ€ã€‚
2. **è¿ç§»æ–‡ç¬”é£æ ¼**ï¼šå¿…é¡»å½»åº•åœ°æ¨¡ä»¿ã€Œé£æ ¼èŒƒä¾‹ã€çš„ç¬”è§¦ã€‚è¿™åŒ…æ‹¬ï¼š
   - **è¯æ±‡é€‰æ‹©**ï¼šä½¿ç”¨ä¸èŒƒä¾‹ç›¸ä¼¼çš„è¯æ±‡åå¥½ï¼ˆä¾‹å¦‚ï¼Œæ˜¯ç”¨"åä¸½è¾è—»"è¿˜æ˜¯"æœ´å®ç™½æ"ï¼‰
   - **å¥å¼ç»“æ„**ï¼šæ¨¡ä»¿èŒƒä¾‹çš„é•¿çŸ­å¥æ­é…ã€å€’è£…ã€æ’æ¯”ç­‰å¥å¼ç‰¹ç‚¹
   - **å™äº‹èŠ‚å¥**ï¼šæ¨¡ä»¿èŒƒä¾‹æ˜¯"å¿«èŠ‚å¥æ¨è¿›"è¿˜æ˜¯"æ…¢èŠ‚å¥é“ºé™ˆ"
   - **æƒ…æ„ŸåŸºè°ƒ**ï¼šæ¨¡ä»¿èŒƒä¾‹çš„æ•´ä½“æƒ…ç»ªè‰²å½©ï¼ˆå¦‚å†·é™ã€æ¿€æ˜‚ã€æ‚²ä¼¤ç­‰ï¼‰
   - **æ ‡ç‚¹ç¬¦å·ç”¨æ³•**ï¼šæ³¨æ„èŒƒä¾‹ä¸­ç‰¹æ®Šæ ‡ç‚¹ï¼ˆå¦‚ç ´æŠ˜å·ã€çœç•¥å·ï¼‰çš„ä½¿ç”¨ä¹ æƒ¯

---

[é£æ ¼èŒƒä¾‹]
{formatted_examples}

---

[åŸå§‹æ–‡æœ¬]
{original_text}

---

[é¢å¤–è¦æ±‚]
{extra_prompt if extra_prompt else "æ— "}

------

ç°åœ¨ï¼Œè¯·å¼€å§‹ä»¿å†™ã€‚ç›´æ¥è¾“å‡ºä»¿å†™åçš„æ­£æ–‡ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæˆ–æ ‡é¢˜ã€‚"""
    
    return prompt

def get_enhanced_chapter_prompt(
    outline: Dict,
    references: Dict,
    extra_prompt: str = "",
    context_info: str = "",
    story_config: Optional[Dict] = None,
    sync_info: Optional[Dict] = None,
    ai_score_target: float = 20.0,
    current_dialogue_ratio: float = 0.0
) -> str:
    """ç”Ÿæˆå¢å¼ºç‰ˆç« èŠ‚å†…å®¹æç¤ºè¯ï¼Œé’ˆå¯¹æ€§é™ä½AIæµ“åº¦"""
    
    # è·å–åŸºæœ¬ä¿¡æ¯
    novel_number = outline.get('chapter_number', 0)
    chapter_title = outline.get('title', 'æœªçŸ¥')
    
    # æ ¼å¼åŒ–å…³é”®æƒ…èŠ‚ç‚¹
    key_points_list = outline.get('key_points', [])
    key_points_display = chr(10).join([f"- {point}" for point in key_points_list])
    
    # å…¶ä»–ä¿¡æ¯
    characters = ', '.join(outline.get('characters', []))
    settings = ', '.join(outline.get('settings', []))
    conflicts = ', '.join(outline.get('conflicts', []))

    base_prompt = f"""ä½ æ˜¯ä¸€åä¸“ä¸šç½‘æ–‡ä½œè€…ï¼Œç†ŸçŸ¥èµ·ç‚¹ä¸­æ–‡ç½‘ã€ç•ªèŒ„å°è¯´ç½‘ã€æ™‹æ±Ÿæ–‡å­¦åŸçš„ç½‘æ–‡åˆ›ä½œæŠ€å·§ï¼Œä½ çš„æ–‡ç¬”èŠ‚å¥ã€è¡¨è¾¾å¯Œäºå˜åŒ–ï¼Œè¯­å¥æ€»æ˜¯è¶…å‡ºé¢„æµ‹ï¼ŒåŒæ—¶æ‰£äººå¿ƒå¼¦ã€‚ä½ ç‰¹åˆ«æ“…é•¿åˆ›ä½œèŠ‚å¥ç´§å‡‘ã€å¯¹è¯ç”ŸåŠ¨ã€ä¸”æå…·äººæ€§åŒ–ç‰¹è‰²çš„ç½‘ç»œå°è¯´ã€‚

âš ï¸ ç‰¹åˆ«é‡è¦ï¼šæœ¬æ¬¡åˆ›ä½œå¿…é¡»é€šè¿‡ä¸“ä¸šAIæ£€æµ‹å·¥å…·çš„éªŒè¯ï¼Œç›®æ ‡AIæ£€æµ‹ç»“æœä½äº{ai_score_target:.0f}%ã€‚

[AIæ£€æµ‹ä¼˜åŒ–è¦æ±‚]
1. **å¯¹è¯ä¸»å¯¼åŸåˆ™**ï¼ˆæœ€é‡è¦ï¼‰ï¼š
   - å¯¹è¯æ¯”ä¾‹å¿…é¡»è¾¾åˆ°45%ä»¥ä¸Šï¼ˆå½“å‰ä»…{current_dialogue_ratio:.1%}ï¼‰
   - ç”¨å¯¹è¯æ¨è¿›å‰§æƒ…ï¼Œå¤§å¹…å‡å°‘å™è¿°
   - æ¯ä¸ªäººç‰©è¯´è¯è¦æœ‰æ˜æ˜¾çš„ä¸ªäººç‰¹è‰²
   - åŠ å…¥"å‘ƒ"ã€"é‚£ä¸ª"ã€"æ€ä¹ˆè¯´å‘¢"ç­‰åœé¡¿è¯

2. **è¯æ±‡å½»åº•å» AIåŒ–**ï¼š
   - ç¦æ­¢ä½¿ç”¨ï¼šä¼´éšç€ã€ä¸æ­¤åŒæ—¶ã€ç´§æ¥ç€ã€æ¯«æ— ç–‘é—®ã€æ˜¾è€Œæ˜“è§
   - ä¼˜å…ˆä½¿ç”¨ï¼šç„¶åã€æ¥ç€ã€çªç„¶ã€ç»“æœã€æ²¡æƒ³åˆ°ã€è°çŸ¥é“
   - å¤šç”¨å£è¯­åŒ–è¡¨è¾¾ï¼šè¿™ç©æ„å„¿ã€ä»€ä¹ˆé¬¼ã€æä»€ä¹ˆ

[ç« èŠ‚ä¿¡æ¯]
ç« èŠ‚å·: {novel_number}
æ ‡é¢˜: {chapter_title}
å…³é”®æƒ…èŠ‚ç‚¹:
{key_points_display}

[æ ¸å¿ƒå…ƒç´ ]
äººç‰©: {characters}
åœºæ™¯: {settings}
å†²çª: {conflicts}

[è¾“å‡ºè¦æ±‚]
1. ä»…è¿”å›ç« èŠ‚æ­£æ–‡æ–‡æœ¬ï¼Œä»¥â€œç¬¬{novel_number}ç«  {chapter_title}â€å¼€å¤´ã€‚
2. ä¸¥æ ¼ä½¿ç”¨ç®€ä½“ä¸­æ–‡åŠä¸­æ–‡æ ‡ç‚¹ç¬¦å·â€œâ€ã€‚
3. ç¡®ä¿å¯¹è¯æ¯”ä¾‹è¾¾åˆ°45%ä»¥ä¸Šã€‚
4. å¿…é¡»å¤§é‡ä½¿ç”¨å£è¯­åŒ–è¡¨è¾¾å’Œè‡ªç„¶åœé¡¿ã€‚"""

    # ç”Ÿæˆè‡ªé€‚åº”äººæ€§åŒ–æç¤ºè¯
    adaptive_prompt = generate_adaptive_humanization_prompt(
        ai_score=100 - ai_score_target,
        dialogue_ratio=current_dialogue_ratio,
        content_type="chapter"
    )
    base_prompt += f"{chr(10)}{adaptive_prompt}"

    # æ·»åŠ é¢å¤–è¦æ±‚
    if extra_prompt:
        base_prompt += f"{chr(10)}[é¢å¤–è¦æ±‚]{chr(10)}{extra_prompt}"

    # æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
    if context_info:
        max_context_length = 1000
        if len(context_info) > max_context_length:
            context_info = context_info[-max_context_length:] + "...(å‰æ–‡å·²çœç•¥)"
        base_prompt += f"{chr(10)}[ä¸Šä¸‹æ–‡ä¿¡æ¯]{chr(10)}{context_info}"

    return base_prompt
