# 仿写功能使用指南

## 概述

OCNovel项目的仿写功能是一个强大的AI文本风格迁移工具，能够将原始文本按照指定的风格范文进行智能仿写，实现风格的完美迁移。该功能支持手动仿写和自动仿写两种模式。

## 功能特点

### 🎯 核心特性
- **智能风格识别**：通过知识库检索技术，自动识别与原始文本最相关的风格片段
- **精准风格迁移**：保留原始文本的核心意义，同时完全迁移目标风格的写作特点
- **多种风格支持**：内置古风雅致、悬疑紧张、热血激昂等多种风格
- **自动触发机制**：在小说生成流程中自动触发仿写，无需手动干预
- **质量控制**：内置内容保持度和风格一致性检查

### 🔧 技术优势
- **临时知识库**：为每次仿写构建专用的临时知识库，确保风格分析的准确性
- **语义检索**：使用先进的嵌入模型进行语义相似性检索
- **提示词优化**：精心设计的仿写提示词，确保风格迁移的效果
- **错误处理**：完善的异常处理机制，确保仿写过程的稳定性

## 使用方法

### 1. 手动仿写

#### 基本语法
```bash
python main.py imitate \
    --style-source <风格源文件> \
    --input-file <原始文本文件> \
    --output-file <输出文件> \
    [--extra-prompt "额外要求"]
```

#### 参数说明
- `--style-source`：必需，作为风格参考的源文件路径
- `--input-file`：必需，需要进行仿写的原始文本文件路径
- `--output-file`：必需，仿写结果的输出文件路径
- `--extra-prompt`：可选，额外的仿写要求或指导

#### 使用示例

**示例1：将现代文仿写为古风雅致风格**
```bash
python main.py imitate \
    --style-source data/reference/古风风格参考.txt \
    --input-file my_modern_text.txt \
    --output-file ancient_style_output.txt \
    --extra-prompt "保持古风韵味，增加诗词意境"
```

**示例2：将简单描述仿写为悬疑紧张风格**
```bash
python main.py imitate \
    --style-source data/reference/悬疑风格参考.txt \
    --input-file simple_description.txt \
    --output-file mystery_style_output.txt \
    --extra-prompt "营造悬疑氛围，增加紧张感"
```

**示例3：将对话仿写为热血激昂风格**
```bash
python main.py imitate \
    --style-source data/reference/热血风格参考.txt \
    --input-file dialogue.txt \
    --output-file epic_style_output.txt \
    --extra-prompt "保持热血节奏，增强战斗场面"
```

### 2. 自动仿写

#### 配置说明
自动仿写功能在`config.json`的`imitation_config`部分进行配置：

```json
{
  "imitation_config": {
    "enabled": true,
    "auto_imitation": {
      "enabled": true,
      "trigger_all_chapters": true,
      "style_sources": [
        {
          "name": "古风雅致",
          "file_path": "data/reference/古风风格参考.txt",
          "description": "古风雅致的文风，适合玄幻仙侠类小说",
          "extra_prompt": "保持古风韵味，增加诗词意境"
        },
        {
          "name": "悬疑紧张",
          "file_path": "data/reference/悬疑风格参考.txt",
          "description": "悬疑紧张的氛围，适合推理惊悚类小说",
          "extra_prompt": "营造悬疑氛围，增加紧张感"
        },
        {
          "name": "热血激昂",
          "file_path": "data/reference/热血风格参考.txt",
          "description": "热血激昂的节奏，适合战斗冒险类小说",
          "extra_prompt": "保持热血节奏，增强战斗场面"
        }
      ],
      "default_style": "古风雅致",
      "output_suffix": "_imitated",
      "backup_original": true
    }
  }
}
```

#### 触发机制
- **全局仿写**：`trigger_all_chapters: true` - 对所有章节进行仿写
- **指定章节**：`trigger_all_chapters: false` + `trigger_chapters: [5, 10, 15]` - 仅对指定章节进行仿写

#### 工作流程
1. 章节内容生成完成后进入定稿阶段
2. 检查是否开启全局仿写功能
3. 如果开启，自动读取默认风格源文件
4. 构建临时知识库并检索风格范例
5. 生成仿写内容并保存（文件名后缀：`_imitated`）
6. 备份原文件（文件名后缀：`_original`）

## 风格参考文件

### 内置风格
项目内置了三种经典风格参考文件：

1. **古风雅致** (`data/reference/古风风格参考.txt`)
   - 适合：玄幻仙侠类小说
   - 特点：文言词汇、诗词意境、典雅表达
   - 示例：使用"赤乌衔耀"、"玉案"、"神识探查"等古风词汇

2. **悬疑紧张** (`data/reference/悬疑风格参考.txt`)
   - 适合：推理惊悚类小说
   - 特点：紧张氛围、细节描写、悬念营造
   - 示例：注重环境描写和人物心理刻画

3. **热血激昂** (`data/reference/热血风格参考.txt`)
   - 适合：战斗冒险类小说
   - 特点：快节奏、激昂情绪、动作描写
   - 示例：使用"战鼓擂动"、"声震九霄"等激昂词汇

### 自定义风格
您可以添加自己的风格参考文件：

1. 准备风格参考文本（建议5000-50000字符）
2. 将文件放在`data/reference/`目录下
3. 在`config.json`中添加新的风格配置：

```json
{
  "name": "我的风格",
  "file_path": "data/reference/我的风格参考.txt",
  "description": "我的自定义风格描述",
  "extra_prompt": "我的额外要求"
}
```

## 仿写效果展示

### 原始文本（现代风格）
```
这是一个普通的下午，阳光透过窗户洒在桌子上。小明坐在电脑前，正在写代码。他是一名程序员，每天都要面对各种技术问题。

突然，手机响了。是小红的电话。
"喂，小红，有什么事吗？"
"小明，你能帮我看看这个bug吗？我搞了一整天都没解决。"
```

### 仿写结果（古风雅致风格）
```
这是一个寻常的午后，赤乌衔耀，金芒凿破疏窗，洒落在案牍之上。秦明盘坐于玉案前，指尖轻点，正凝神推演《九转玄黄阵》阵图。他乃宗门内阵法一道的翘楚，每日皆需勘破各般玄奥迷局。

忽而，案旁一枚青玉符轻颤，流光溢彩。是小红师妹的传音。
"喂，小红，有何要事？"
"秦明师兄，可否助小妹勘破一道心魔？小妹已耗费一日夜，始终不得其解。"
```

## 质量控制

### 内容保持度检查
- 确保仿写后的文本保留原始文本的所有关键信息
- 检查情节逻辑的完整性
- 验证人物对话的核心含义

### 风格一致性检查
- 验证词汇选择是否符合目标风格
- 检查句式结构是否模仿到位
- 确认情感基调是否一致

### 相似度阈值
- 最小风格相似度：0.7（可配置）
- 最大重试次数：3次（可配置）

## 故障排除

### 常见问题

**Q: 仿写结果风格不够明显怎么办？**
A: 尝试增加风格参考文件的内容，或者调整`extra_prompt`参数，提供更具体的风格要求。

**Q: 仿写后内容丢失了重要信息怎么办？**
A: 检查原始文本是否过于复杂，可以尝试分段仿写，或者调整知识库的检索参数。

**Q: 自动仿写没有触发怎么办？**
A: 检查`config.json`中的`imitation_config.auto_imitation.enabled`和`trigger_all_chapters`设置。

**Q: 仿写速度太慢怎么办？**
A: 可以调整知识库的`chunk_size`和`chunk_overlap`参数，或者减少检索的范例数量。

### 调试技巧

1. **查看日志**：检查`data/logs/`目录下的日志文件
2. **测试配置**：运行`python test_imitation_logic.py`验证配置
3. **手动测试**：使用`python test_imitation_demo.py`进行功能演示
4. **检查文件**：确认风格参考文件存在且内容有效

## 最佳实践

### 1. 风格参考文件准备
- 选择高质量、风格鲜明的参考文本
- 确保参考文本长度适中（5000-50000字符）
- 避免包含过多对话或特殊格式

### 2. 原始文本优化
- 保持文本结构清晰
- 避免过于复杂的嵌套句式
- 确保核心信息突出

### 3. 参数调优
- 根据文本长度调整`chunk_size`
- 根据风格特点调整`extra_prompt`
- 根据质量要求调整相似度阈值

### 4. 结果验证
- 对比原始文本和仿写结果
- 检查风格迁移效果
- 验证内容完整性

## 技术原理

### 工作流程
1. **文本预处理**：读取原始文本和风格参考文件
2. **知识库构建**：为风格参考文件构建临时向量数据库
3. **语义检索**：使用嵌入模型检索最相关的风格片段
4. **提示词生成**：结合原始文本、风格范例和额外要求生成提示词
5. **AI生成**：调用大语言模型生成仿写内容
6. **结果保存**：保存仿写结果并备份原文件

### 核心技术
- **向量数据库**：使用FAISS进行高效的相似性检索
- **嵌入模型**：使用OpenAI的text-embedding-ada-002模型
- **大语言模型**：支持Gemini和OpenAI的多种模型
- **提示工程**：精心设计的仿写提示词模板

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实现基础仿写功能
- ✅ 支持手动和自动仿写模式
- ✅ 内置三种经典风格
- ✅ 完善的质量控制机制
- ✅ 详细的错误处理和日志记录

### 计划功能
- 🔄 支持更多风格类型
- 🔄 增加风格混合功能
- 🔄 优化检索算法
- 🔄 增加批量处理功能
- 🔄 支持实时风格预览

---

*本指南将随着功能的更新而持续完善。如有问题或建议，请参考项目文档或提交Issue。* 